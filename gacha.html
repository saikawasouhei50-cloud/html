<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìºë¦­í„° ë½‘ê¸° ê²Œì„</title>
    <!-- Tailwind CSSë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹ ë¥´ê³  ë©‹ì§„ ë””ìì¸ì„ ì ìš©í•©ë‹ˆë‹¤ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì‚¬ìš©ì ì •ì˜ ì• ë‹ˆë©”ì´ì…˜ ë° ìŠ¤íƒ€ì¼ */
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
        body {
            font-family: 'Jua', sans-serif;
            background-image: linear-gradient(to top, #30cfd0 0%, #330867 100%);
        }

        /* ì¹´ë“œê°€ ë‚˜íƒ€ë‚  ë•Œì˜ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .card-animation { animation: fadeIn 0.5s ease-out forwards; }

        /* ë“±ê¸‰ë³„ ì¹´ë“œ ë°°ê²½ ê·¸ë¼ë°ì´ì…˜ */
        .rarity-N { background-image: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%); }
        .rarity-R { background-image: linear-gradient(to top, #a1c4fd 0%, #c2ebf0 100%); }
        .rarity-SR { background-image: linear-gradient(to right, #f83292, #7122fa); }
        .rarity-SSR { background-image: linear-gradient(to right, #f78ca0 0%, #f9748f 19%, #fd868c 60%, #fe9a8b 100%); }

        /* ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
        .gacha-button { transition: all 0.3s ease; }
        .gacha-button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); }
        
        /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button.active { background-color: #f6e05e; color: #330867; }
        
        /* ì¹´ë“œ ê°œìˆ˜ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .count-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #e53e3e;
            color: white;
            font-size: 14px;
            font-weight: bold;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        /* ë± ìŠ¬ë¡¯ ìŠ¤íƒ€ì¼ */
        .deck-slot {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
        }
        /* í™ˆ í™”ë©´ ìºë¦­í„° ì´ë¯¸ì§€ */
        #home-character-image {
            max-height: 60vh;
            object-fit: contain;
            filter: drop-shadow(0px 5px 15px rgba(0,0,0,0.5));
            transition: transform 0.3s ease-in-out;
        }
        #home-character-image:hover {
            transform: scale(1.03);
        }
        /* ì´ë²¤íŠ¸ ë°°ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 255, 100, 0.4); }
            50% { box-shadow: 0 0 25px rgba(255, 255, 100, 0.8); }
        }
        #event-banner {
            animation: pulse-glow 2.5s infinite ease-in-out;
        }
        /* ë½‘ê¸° íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .gacha-tab-button { transition: all 0.2s ease-in-out; }
        .gacha-tab-button.active { background-color: rgba(246, 224, 94, 0.8); color: #330867; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-5xl bg-white/10 backdrop-blur-md rounded-2xl shadow-xl text-white p-6 md:p-8">
        
        <!-- ì œëª© ë¶€ë¶„ -->
        <header class="text-center mb-4">
            <h1 class="text-4xl md:text-5xl font-bold tracking-wider text-yellow-300" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">âœ¨ ìºë¦­í„° ì›”ë“œ âœ¨</h1>
        </header>

        <!-- ì¬í™” ë° íƒ­ ë©”ë‰´ ì˜ì—­ -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
            <div class="bg-black/20 rounded-full p-1 flex-shrink-0">
                <button id="tab-home" class="tab-button active font-bold py-2 px-6 rounded-full">í™ˆ</button>
                <button id="tab-gacha" class="tab-button font-bold py-2 px-6 rounded-full">ë½‘ê¸°</button>
                <button id="tab-inventory" class="tab-button font-bold py-2 px-6 rounded-full">ë³´ê´€í•¨</button>
                <button id="tab-deck" class="tab-button font-bold py-2 px-6 rounded-full">ë± ê´€ë¦¬</button>
                <button id="tab-combat" class="tab-button font-bold py-2 px-6 rounded-full">ì „íˆ¬</button>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-2xl font-bold text-yellow-300 bg-black/20 py-2 px-6 rounded-full inline-block">ğŸ’ <span id="currency-display">100</span></div>
                <button id="reset-game" class="gacha-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full text-sm">ì´ˆê¸°í™”</button>
            </div>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
        <main>
             <!-- ì €ì¥ ë¶ˆê°€ ê²½ê³  ë©”ì‹œì§€ -->
            <div id="storage-warning" class="hidden text-center bg-red-500 p-2 rounded-lg mb-4">
                <strong>ê²½ê³ :</strong> ê²Œì„ ì§„í–‰ ìƒí™©ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ê°€ ì‹œí¬ë¦¿ ëª¨ë“œì´ê±°ë‚˜ ì €ì¥ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.
            </div>

            <!-- í™ˆ í™”ë©´ -->
            <div id="home-view">
                <div class="relative min-h-[50vh] flex flex-col justify-center items-center text-center p-4">
                    <!-- ì´ë²¤íŠ¸ ë°°ë„ˆ -->
                    <div id="event-banner" class="hidden absolute top-4 right-4 bg-gradient-to-r from-yellow-400 via-red-500 to-pink-500 p-4 rounded-lg shadow-lg cursor-pointer transform hover:scale-105 transition-transform duration-300 z-10">
                        <h3 class="text-white text-lg font-bold drop-shadow-md">ê¸°ê°„ í•œì • ì´ë²¤íŠ¸!</h3>
                        <p class="text-white text-sm drop-shadow-md">SSR íƒ€ë½ì²œì‚¬ í™•ë¥  UP!</p>
                    </div>

                    <div id="home-character-container" class="flex-grow flex items-center justify-center cursor-pointer">
                        <img id="home-character-image" src="" alt="ëŒ€í‘œ ìºë¦­í„°" class="max-w-full">
                    </div>
                    <div id="home-dialogue-container" class="w-full max-w-2xl bg-black/30 backdrop-blur-sm p-4 rounded-xl mt-4">
                        <p id="home-character-name" class="font-bold text-lg text-yellow-300"></p>
                        <p id="home-character-dialogue" class="text-white"></p>
                    </div>
                     <div id="home-default-message" class="text-2xl text-gray-300">
                        ë³´ê´€í•¨ì—ì„œ ëŒ€í‘œ ìºë¦­í„°ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”!
                    </div>
                </div>
            </div>

            <!-- ë½‘ê¸° í™”ë©´ -->
            <div id="gacha-view" class="hidden">
                <p class="text-center text-gray-200 mt-2 mb-4">ìš´ëª…ì„ ì‹œí—˜í•˜ì—¬ ì „ì„¤ì˜ ë™ë£Œë¥¼ ë§Œë‚˜ë³´ì„¸ìš”!</p>
                
                <!-- Gacha Type Tabs -->
                <div class="bg-black/20 rounded-full p-1 flex justify-center items-center mb-4 max-w-sm mx-auto">
                    <button id="gacha-tab-normal" class="gacha-tab-button active w-1/2 font-bold py-2 px-6 rounded-full">ì¼ë°˜ ë½‘ê¸°</button>
                    <button id="gacha-tab-event" class="gacha-tab-button w-1/2 font-bold py-2 px-6 rounded-full hidden">ì´ë²¤íŠ¸ ë½‘ê¸°</button>
                </div>

                <!-- Normal Gacha View -->
                <div id="normal-gacha-view">
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-4">
                        <button id="pull-one" class="gacha-button w-full sm:w-auto bg-blue-500 hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">ğŸ’ 1íšŒ ë½‘ê¸° (10)</button>
                        <button id="pull-ten" class="gacha-button w-full sm:w-auto bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">ğŸ’ğŸ’ 10íšŒ ë½‘ê¸° (100)</button>
                    </div>
                </div>

                <!-- Event Gacha View -->
                <div id="event-gacha-view" class="hidden">
                    <div class="text-center p-2 mb-2 rounded-lg bg-yellow-500/20">
                        <p class="font-bold text-yellow-300">[íƒ€ë½ì²œì‚¬] ë“±ì¥ í™•ë¥  UP!</p>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-4">
                        <button id="pull-one-event" class="gacha-button w-full sm:w-auto bg-gradient-to-r from-red-500 to-yellow-500 hover:from-red-600 hover:to-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">ğŸ”¥ 1íšŒ ë½‘ê¸° (10)</button>
                        <button id="pull-ten-event" class="gacha-button w-full sm:w-auto bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">ğŸ”¥ğŸ”¥ 10íšŒ ë½‘ê¸° (100)</button>
                    </div>
                </div>

                <div id="message-area" class="text-center text-lg h-8 mb-4 transition-opacity duration-300"></div>
                <div id="results-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[200px] bg-black/20 p-4 rounded-xl"></div>
            </div>

            <!-- ë³´ê´€í•¨ í™”ë©´ -->
            <div id="inventory-view" class="hidden">
                 <div class="text-center mb-4">
                    <p class="text-gray-200">ì§€ê¸ˆê¹Œì§€ ìˆ˜ì§‘í•œ ë™ë£Œë“¤ì…ë‹ˆë‹¤.</p>
                    <div class="mt-2 flex justify-center items-center gap-4">
                        <p id="inventory-status" class="text-lg font-bold bg-black/20 py-2 px-4 rounded-full"></p>
                        <button id="expand-inventory" class="gacha-button bg-yellow-500 hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed text-black font-bold py-2 px-4 rounded-full shadow-lg text-sm">ì¹¸ í™•ì¥ (ğŸ’50)</button>
                    </div>
                </div>
                <div id="inventory-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[400px] max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl"></div>
            </div>

            <!-- ë± ê´€ë¦¬ í™”ë©´ -->
            <div id="deck-view" class="hidden">
                <div class="text-center mb-4">
                    <p class="text-gray-200">ìµœê°•ì˜ ë±ì„ êµ¬ì„±í•˜ì—¬ ì „íˆ¬ë¥¼ ì¤€ë¹„í•˜ì„¸ìš”! (5ì¥ í•„ìˆ˜)</p>
                    <div class="mt-2 flex justify-center items-center gap-4">
                        <div id="deck-status" class="text-lg font-bold text-yellow-300"></div>
                        <button id="auto-fill-deck" class="gacha-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg text-sm">ìë™ í¸ì„±</button>
                    </div>
                </div>
                <div id="deck-slots-container" class="grid grid-cols-5 gap-4 mb-6 bg-black/20 p-4 rounded-xl"></div>
                <div id="deck-inventory-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[250px] max-h-[40vh] overflow-y-auto bg-black/20 p-4 rounded-xl"></div>
            </div>
            
            <!-- ì „íˆ¬ í™”ë©´ -->
            <div id="combat-view" class="hidden">
                <div class="text-center mb-4">
                    <p class="text-gray-200">í¸ì„±í•œ ë±ìœ¼ë¡œ ë˜ì „ì— ë„ì „í•˜ì—¬ ë³´ìƒì„ íšë“í•˜ì„¸ìš”!</p>
                    <p class="text-xl font-bold">í˜„ì¬ ë± ì „íˆ¬ë ¥: <span id="deck-power-display" class="text-yellow-300">0</span></p>
                </div>
                <div id="combat-message-area" class="text-center text-lg h-8 mb-4 transition-opacity duration-300"></div>
                <div id="dungeon-list-container" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>
        </main>
    </div>

    <script>
        // --- ê²Œì„ ì„¤ì • ---
        const characters = [
            { name: 'ìŠ¬ë¼ì„', rarity: 'N', power: 1, imageUrl: 'https://placehold.co/300x500/a0aec0/ffffff?text=Slime', cardImageUrl: 'https://placehold.co/150x180/a0aec0/ffffff?text=Slime', dialogues: ['ê¾¸ë¬¼... ê¾¸ë¬¼...', 'ë‚´ê°€... ëŒ€í‘œ?', 'ë§ë‘ë§ë‘...'] }, 
            { name: 'ê³ ë¸”ë¦°', rarity: 'N', power: 2, imageUrl: 'https://placehold.co/300x500/a0aec0/ffffff?text=Goblin', cardImageUrl: 'https://placehold.co/150x180/a0aec0/ffffff?text=Goblin', dialogues: ['í‚¤í‚¥!', 'ë°˜ì§ì´ëŠ” ê±°, ì¢‹ì•„!', 'ë‚´ ëª½ë‘¥ì´, ê°•í•˜ë‹¤!'] }, 
            { name: 'ë“¤ì¥', rarity: 'N', power: 1, imageUrl: 'https://placehold.co/300x500/a0aec0/ffffff?text=Rat', cardImageUrl: 'https://placehold.co/150x180/a0aec0/ffffff?text=Rat', dialogues: ['ì°ì°!', 'ì¹˜ì¦ˆ... ì¢‹ì•„...', 'ìˆ¨ëŠ” ê±´ ìì‹ ìˆì–´.'] }, 
            { name: 'ì˜¤í¬ ì „ì‚¬', rarity: 'R', power: 5, imageUrl: 'https://placehold.co/300x500/63b3ed/ffffff?text=Orc', cardImageUrl: 'https://placehold.co/150x180/63b3ed/ffffff?text=Orc', dialogues: ['í¬ì•„ì•„! ì „íˆ¬ë‹¤!', 'ë‚´ ë„ë¼ë¥¼ ë°›ì•„ë¼!', 'ë” ê°•í•œ ìëŠ” ì—†ë‚˜?'] }, 
            { name: 'ì—˜í”„ ê¶ìˆ˜', rarity: 'R', power: 7, imageUrl: 'https://i.postimg.cc/MKyM7Bqx/900px-Electron-shell-001-Hydrogen-no-label-svg.png', cardImageUrl: 'https://i.postimg.cc/k4tLVq8v/900px-Electron-shell-001-Hydrogen-no-label-svg.png', dialogues: ['ë°”ëŒì˜ ì†ì‚­ì„ì´ ë“¤ë¦¬ëŠ”êµ°...', 'ë‚´ í™”ì‚´ì€ ë¹—ë‚˜ê°€ì§€ ì•Šì•„.', 'ìˆ²ì„ ìœ„í•˜ì—¬.'] }, 
            { name: 'ì¸ê°„ ê¸°ì‚¬', rarity: 'R', power: 6, imageUrl: 'https://placehold.co/300x500/63b3ed/ffffff?text=Knight', cardImageUrl: 'https://placehold.co/150x180/63b3ed/ffffff?text=Knight', dialogues: ['ì •ì˜ì˜ ì´ë¦„ìœ¼ë¡œ!', 'ë°©íŒ¨ ë’¤ì— ì„œë„ë¡.', 'ì´ ê²€ì— ë§¹ì„¸í•˜ì§€.'] }, 
            { name: 'í•˜ì´ ì˜¤í¬', rarity: 'SR', power: 15, imageUrl: 'https://placehold.co/300x500/b794f4/ffffff?text=High+Orc', cardImageUrl: 'https://placehold.co/150x180/b794f4/ffffff?text=High+Orc', dialogues: ['ëª¨ì¡°ë¦¬ ë¶€ìˆ´ì£¼ë§ˆ!', 'ë‚˜ëŠ”... ë¶€ì¡±ì˜ ìë‘ì´ë‹¤.', 'í˜ã“ãå…¨ã¦(í˜ì´ì•¼ë§ë¡œ ì „ë¶€)!'] }, 
            { name: 'ë§ˆë²•ì‚¬', rarity: 'SR', power: 18, imageUrl: 'https://placehold.co/300x500/b794f4/ffffff?text=Mage', cardImageUrl: 'https://placehold.co/150x180/b794f4/ffffff?text=Mage', dialogues: ['ì§€ì‹ì˜ ì‹¬ì—°ì„ ë“¤ì—¬ë‹¤ë³¸ ì  ìˆë‚˜?', 'ë§ˆë‚˜ì˜ íë¦„ì´ ëŠê»´ì§„ë‹¤...', 'ì´ê²Œ ë°”ë¡œ... ë§ˆë²•ì´ë‹¤.'] }, 
            { name: 'ë“œë˜ê³¤', rarity: 'SSR', power: 35, imageUrl: 'https://placehold.co/300x500/f6e05e/000000?text=Dragon', cardImageUrl: 'https://placehold.co/150x180/f6e05e/000000?text=Dragon', dialogues: ['í•˜ì°®ì€ í•„ë©¸ìë¡œêµ°.', 'ë‚˜ì˜ ë¶„ë…¸ë¥¼ ê°ë‹¹í•  ìˆ˜ ìˆê² ë‚˜?', 'ì´ ì„¸ìƒì˜ ì§€ë°°ìëŠ” ë‚˜ë‹¤.'] }, 
            { name: 'íƒ€ë½ì²œì‚¬', rarity: 'SSR', power: 40, imageUrl: 'https://placehold.co/300x500/f6e05e/000000?text=Fallen+Angel', cardImageUrl: 'https://placehold.co/150x180/f6e05e/000000?text=Fallen+Angel', dialogues: ['ë‚ ê°œëŠ” ìƒì—ˆì§€ë§Œ, ê¸ì§€ëŠ” ìƒì§€ ì•Šì•˜ë‹¤.', 'ì–´ë‘  ì†ì—ì„œ... ì§„ì‹¤ì„ ë³´ì•˜ì§€.', 'í›„íšŒëŠ” ì—†ë‹¤.'] },
        ];
        const rarityProbabilities = { 'SSR': 3, 'SR': 12, 'R': 35, 'N': 50 };
        const eventRarityProbabilities = { 'SSR': 6, 'SR': 14, 'R': 30, 'N': 50 };
        const EVENT_CHARACTER_NAME = 'íƒ€ë½ì²œì‚¬';
        const dungeons = [
            { name: 'ì´ˆë³´ìì˜ ìˆ²', recommendedPower: 20, rewards: { min: 10, max: 20 } },
            { name: 'ì˜¤í¬ ì ë ¹ì§€', recommendedPower: 50, rewards: { min: 25, max: 40 } },
            { name: 'ìš©ì˜ ë‘¥ì§€', recommendedPower: 120, rewards: { min: 60, max: 100 } },
        ];
        const EVENT_START_DATE = new Date('2025-10-14T00:00:00');
        const EVENT_END_DATE = new Date('2025-10-24T23:59:59');

        // --- ê²Œì„ ìƒíƒœ ---
        let playerCurrency = 100;
        let playerInventory = [];
        let playerDeck = [];
        let inventoryCapacity = 100;
        let representativeCharacter = null;
        const DECK_CAPACITY = 5;
        const PULL_ONE_COST = 10;
        const PULL_TEN_COST = 100;
        const EXPAND_COST = 50;
        const EXPAND_AMOUNT = 10;
        const SAVE_DATA_KEY = 'gachaGameSaveData_v3'; // ë²„ì „ì„ ëª…ì‹œí•˜ì—¬ ì´ì „ ë°ì´í„°ì™€ ì¶©ëŒ ë°©ì§€

        // --- HTML ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const currencyDisplay = document.getElementById('currency-display');
        const messageArea = document.getElementById('message-area');
        const allTabs = document.querySelectorAll('.tab-button');
        const allViews = document.querySelectorAll('main > div');
        const pullOneButton = document.getElementById('pull-one');
        const pullTenButton = document.getElementById('pull-ten');
        const pullOneEventButton = document.getElementById('pull-one-event');
        const pullTenEventButton = document.getElementById('pull-ten-event');
        const resultsContainer = document.getElementById('results-container');
        const inventoryContainer = document.getElementById('inventory-container');
        const inventoryStatus = document.getElementById('inventory-status');
        const expandInventoryButton = document.getElementById('expand-inventory');
        const deckStatus = document.getElementById('deck-status');
        const deckSlotsContainer = document.getElementById('deck-slots-container');
        const deckInventoryContainer = document.getElementById('deck-inventory-container');
        const autoFillDeckButton = document.getElementById('auto-fill-deck');
        const deckPowerDisplay = document.getElementById('deck-power-display');
        const combatMessageArea = document.getElementById('combat-message-area');
        const dungeonListContainer = document.getElementById('dungeon-list-container');
        const homeCharacterContainer = document.getElementById('home-character-container');
        const homeCharacterImage = document.getElementById('home-character-image');
        const homeDialogueContainer = document.getElementById('home-dialogue-container');
        const homeDefaultMessage = document.getElementById('home-default-message');
        const homeCharacterName = document.getElementById('home-character-name');
        const homeCharacterDialogue = document.getElementById('home-character-dialogue');
        const eventBanner = document.getElementById('event-banner');
        const gachaTabNormal = document.getElementById('gacha-tab-normal');
        const gachaTabEvent = document.getElementById('gacha-tab-event');
        const normalGachaView = document.getElementById('normal-gacha-view');
        const eventGachaView = document.getElementById('event-gacha-view');
        const resetButton = document.getElementById('reset-game');
        const storageWarning = document.getElementById('storage-warning');
        
        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        allTabs.forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.id.split('-')[1]));
        });
        pullOneButton.addEventListener('click', () => handlePull(1, PULL_ONE_COST, 'normal'));
        pullTenButton.addEventListener('click', () => handlePull(10, PULL_TEN_COST, 'normal'));
        pullOneEventButton.addEventListener('click', () => handlePull(1, PULL_ONE_COST, 'event'));
        pullTenEventButton.addEventListener('click', () => handlePull(10, PULL_TEN_COST, 'event'));
        expandInventoryButton.addEventListener('click', expandInventory);
        autoFillDeckButton.addEventListener('click', autoFillDeck);
        gachaTabNormal.addEventListener('click', () => switchGachaTab('normal'));
        gachaTabEvent.addEventListener('click', () => switchGachaTab('event'));
        deckSlotsContainer.addEventListener('click', (e) => { if (e.target.dataset.action === 'remove-from-deck') removeFromDeck(e.target.dataset.cardName); });
        deckInventoryContainer.addEventListener('click', (e) => { if (e.target.dataset.action === 'add-to-deck') addToDeck(e.target.dataset.cardName); });
        inventoryContainer.addEventListener('click', (e) => { if (e.target.dataset.action === 'set-representative') setRepresentative(e.target.dataset.cardName); });
        dungeonListContainer.addEventListener('click', (e) => { if (e.target.dataset.action === 'challenge-dungeon') challengeDungeon(parseInt(e.target.dataset.dungeonIndex)); });
        homeCharacterContainer.addEventListener('click', () => { if (representativeCharacter) displayHomeView(true); });
        eventBanner.addEventListener('click', () => {
            showMessage('[íƒ€ë½ì²œì‚¬] í™•ë¥  UP ì´ë²¤íŠ¸ ì§„í–‰ ì¤‘!', 'text-blue-300', messageArea);
            switchTab('gacha');
        });
        resetButton.addEventListener('click', resetGame);

        // --- ë°ì´í„° ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ ---
        function isStorageAvailable() {
            try {
                const key = "__test_localstorage__";
                localStorage.setItem(key, key);
                localStorage.removeItem(key);
                return true;
            } catch (e) {
                return false;
            }
        }

        function saveGame() {
            if (!isStorageAvailable()) return;
            const saveData = {
                currency: playerCurrency,
                inventory: playerInventory.map(card => card.name), // ì´ë¦„ë§Œ ì €ì¥
                deck: playerDeck.map(card => card.name), // ì´ë¦„ë§Œ ì €ì¥
                capacity: inventoryCapacity,
                representative: representativeCharacter ? representativeCharacter.name : null,
            };
            localStorage.setItem(SAVE_DATA_KEY, JSON.stringify(saveData));
        }

        function loadGame() {
            if (!isStorageAvailable()) {
                storageWarning.classList.remove('hidden');
                resetButton.disabled = true;
                // ì €ì¥ ê¸°ëŠ¥ ì—†ì´ ìƒˆ ê²Œì„ ì‹œì‘
                playerInventory.push(characters.find(c => c.name === 'ìŠ¬ë¼ì„'));
                playerInventory.push(characters.find(c => c.name === 'ì—˜í”„ ê¶ìˆ˜'));
            } else {
                const savedDataString = localStorage.getItem(SAVE_DATA_KEY);
                if (savedDataString) {
                    try {
                        const savedData = JSON.parse(savedDataString);
                        playerCurrency = savedData.currency ?? 100; // 0ë„ ì •ìƒ ê°’ìœ¼ë¡œ ì¸ì‹í•˜ë„ë¡ ìˆ˜ì •
                        // ì´ë¦„ ë°°ì—´ì„ ê¸°ë°˜ìœ¼ë¡œ ì „ì²´ ìºë¦­í„° ì •ë³´ ì¬êµ¬ì„±
                        playerInventory = (savedData.inventory || []).map(name => characters.find(c => c.name === name)).filter(Boolean);
                        playerDeck = (savedData.deck || []).map(name => characters.find(c => c.name === name)).filter(Boolean);
                        inventoryCapacity = savedData.capacity ?? 100; // 0ë„ ì •ìƒ ê°’ìœ¼ë¡œ ì¸ì‹í•˜ë„ë¡ ìˆ˜ì •
                        if (savedData.representative) {
                            representativeCharacter = characters.find(c => c.name === savedData.representative) || null;
                        }
                    } catch (e) {
                         console.error("ì €ì¥ëœ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:", e);
                         // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì´ˆê¸° ìƒíƒœë¡œ ì‹œì‘
                        playerInventory.push(characters.find(c => c.name === 'ìŠ¬ë¼ì„'));
                        playerInventory.push(characters.find(c => c.name === 'ì—˜í”„ ê¶ìˆ˜'));
                    }
                } else {
                    // ìƒˆë¡œìš´ ê²Œì„ ì‹œì‘
                    playerInventory.push(characters.find(c => c.name === 'ìŠ¬ë¼ì„'));
                    playerInventory.push(characters.find(c => c.name === 'ì—˜í”„ ê¶ìˆ˜'));
                    saveGame(); // ìµœì´ˆ ì‹œì‘ ì‹œ í•œ ë²ˆ ì €ì¥
                }
            }
            updateUI();
            checkEventStatus();
            switchTab('home');
        }

        function resetGame() {
            if (!isStorageAvailable()) return;
            if (resetButton.dataset.confirming === 'true') {
                localStorage.removeItem(SAVE_DATA_KEY);
                location.reload();
            } else {
                resetButton.textContent = 'í™•ì¸?';
                resetButton.dataset.confirming = 'true';
                resetButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                resetButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                setTimeout(() => {
                    resetButton.textContent = 'ì´ˆê¸°í™”';
                    resetButton.dataset.confirming = 'false';
                    resetButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    resetButton.classList.add('bg-red-600', 'hover:bg-red-700');
                }, 3000);
            }
        }


        // --- í•µì‹¬ ê²Œì„ ë¡œì§ í•¨ìˆ˜ ---
        function switchTab(tabName) {
            allViews.forEach(view => view.classList.add('hidden'));
            allTabs.forEach(tab => tab.classList.remove('active'));

            document.getElementById(`${tabName}-view`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'home') displayHomeView();
            else if (tabName === 'inventory') displayInventory(); 
            else if (tabName === 'deck') displayDeckManagement();
            else if (tabName === 'combat') displayCombatView();
        }

        function switchGachaTab(tabName) {
            if (tabName === 'normal') {
                normalGachaView.classList.remove('hidden');
                eventGachaView.classList.add('hidden');
                gachaTabNormal.classList.add('active');
                gachaTabEvent.classList.remove('active');
            } else {
                normalGachaView.classList.add('hidden');
                eventGachaView.classList.remove('hidden');
                gachaTabNormal.classList.remove('active');
                gachaTabEvent.classList.add('active');
            }
        }

        function checkEventStatus() {
            const now = new Date();
            const isEventActive = now >= EVENT_START_DATE && now <= EVENT_END_DATE;
            
            if (isEventActive) {
                eventBanner.classList.remove('hidden');
                gachaTabEvent.classList.remove('hidden');
            } else {
                eventBanner.classList.add('hidden');
                gachaTabEvent.classList.add('hidden');
                if(gachaTabEvent.classList.contains('active')) {
                    switchGachaTab('normal');
                }
            }
        }

        function displayHomeView(cycleDialogue = false) {
            if (representativeCharacter) {
                homeCharacterContainer.classList.remove('hidden');
                homeDialogueContainer.classList.remove('hidden');
                homeDefaultMessage.classList.add('hidden');

                homeCharacterImage.src = representativeCharacter.imageUrl;
                homeCharacterName.textContent = representativeCharacter.name;
                
                if (cycleDialogue) {
                    const currentDialogue = homeCharacterDialogue.textContent;
                    let newDialogue;
                    do {
                        newDialogue = representativeCharacter.dialogues[Math.floor(Math.random() * representativeCharacter.dialogues.length)];
                    } while (representativeCharacter.dialogues.length > 1 && newDialogue === currentDialogue);
                    homeCharacterDialogue.textContent = newDialogue;
                } else {
                     homeCharacterDialogue.textContent = representativeCharacter.dialogues[0];
                }

            } else {
                homeCharacterContainer.classList.add('hidden');
                homeDialogueContainer.classList.add('hidden');
                homeDefaultMessage.classList.remove('hidden');
            }
        }

        function setRepresentative(cardName) {
            const cardData = characters.find(c => c.name === cardName);
            if (cardData) {
                representativeCharacter = cardData;
                showMessage(`${cardData.name}(ì„)ë¥¼ ëŒ€í‘œë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤!`, 'text-blue-300', messageArea);
                displayInventory(); // Re-render inventory to update button state
                saveGame();
            }
        }
        
        function handlePull(count, cost, gachaType = 'normal') {
            if (playerInventory.length + count > inventoryCapacity) {
                showMessage('ë³´ê´€í•¨ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!', 'text-yellow-400', messageArea); return;
            }
            if (playerCurrency >= cost) {
                playerCurrency -= cost;
                showMessage(`-ğŸ’${cost}`, 'text-red-400', messageArea);
                performPulls(count, gachaType);
            } else {
                showMessage('ì¬í™”ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!', 'text-red-400', messageArea);
            }
        }
        
        function expandInventory() {
            if (playerCurrency >= EXPAND_COST) {
                playerCurrency -= EXPAND_COST; inventoryCapacity += EXPAND_AMOUNT;
                showMessage(`ë³´ê´€í•¨ì´ ${inventoryCapacity}ì¹¸ìœ¼ë¡œ í™•ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'text-green-300', messageArea);
                updateUI(); displayInventory(); saveGame();
            } else {
                showMessage('ë³´ì„ì´ ë¶€ì¡±í•˜ì—¬ í™•ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'text-red-400', messageArea);
            }
        }

        function updateUI() {
            currencyDisplay.textContent = playerCurrency;
            const buttons = [pullOneButton, pullTenButton, pullOneEventButton, pullTenEventButton];
            buttons.forEach(btn => {
                if (btn.id.includes('ten')) btn.disabled = playerCurrency < PULL_TEN_COST;
                else btn.disabled = playerCurrency < PULL_ONE_COST;
            });
            expandInventoryButton.disabled = playerCurrency < EXPAND_COST;
        }

        function showMessage(message, colorClass, element) {
            element.textContent = message;
            element.className = `text-center text-lg h-8 mb-4 transition-opacity duration-300 ${colorClass}`;
            setTimeout(() => { element.textContent = ''; }, 2000);
        }

        function performPulls(count, gachaType = 'normal') {
            const results = [];
            let guaranteedSR = (count === 10);
            for (let i = 0; i < count; i++) {
                let pulledChar;
                if (guaranteedSR && i === count - 1 && !results.some(c => c.rarity === 'SR' || c.rarity === 'SSR')) {
                    pulledChar = pullCharacter(['SR', 'SSR'], gachaType);
                } else {
                    pulledChar = pullCharacter(null, gachaType);
                }
                results.push(pulledChar);
                playerInventory.push(pulledChar); 
            }
            displayResults(results); updateUI(); saveGame();
        }

        function pullCharacter(allowedRarities = null, gachaType = 'normal') {
            const now = new Date();
            const isEventActive = now >= EVENT_START_DATE && now <= EVENT_END_DATE;
            const useEventRates = gachaType === 'event' && isEventActive;
            const probabilities = useEventRates ? eventRarityProbabilities : rarityProbabilities;
            
            let selectedRarity = '';
            if (allowedRarities) {
                const highTierProb = { 'SSR': probabilities['SSR'], 'SR': probabilities['SR'] };
                const totalProb = highTierProb.SSR + highTierProb.SR;
                selectedRarity = (Math.random() * totalProb < highTierProb.SSR) ? 'SSR' : 'SR';
            } else {
                const rand = Math.random() * 100; let cumulativeProb = 0;
                for (const rarity in probabilities) {
                    cumulativeProb += probabilities[rarity];
                    if (rand < cumulativeProb) { selectedRarity = rarity; break; }
                }
            }

            if (useEventRates && selectedRarity === 'SSR') {
                if (Math.random() < 0.5) { // 50% chance for event character
                    return characters.find(c => c.name === EVENT_CHARACTER_NAME);
                } else {
                    const otherSSRs = characters.filter(c => c.rarity === 'SSR' && c.name !== EVENT_CHARACTER_NAME);
                    if (otherSSRs.length > 0) return otherSSRs[Math.floor(Math.random() * otherSSRs.length)];
                    return characters.find(c => c.name === EVENT_CHARACTER_NAME); // Fallback
                }
            }

            const possibleCharacters = characters.filter(char => char.rarity === selectedRarity);
            return possibleCharacters[Math.floor(Math.random() * possibleCharacters.length)];
        }

        function displayResults(pulledCharacters) {
            resultsContainer.innerHTML = '';
            pulledCharacters.forEach((character, index) => {
                resultsContainer.appendChild(createCard(character, { animationIndex: index }));
            });
        }
        
        function getUniqueInventory() {
            const cardCounts = playerInventory.reduce((acc, card) => {
                if (card && card.name) {
                    if (!acc[card.name]) { acc[card.name] = { ...card, count: 0 }; }
                    acc[card.name].count++;
                }
                return acc;
            }, {});
            const rarityOrder = { 'SSR': 4, 'SR': 3, 'R': 2, 'N': 1 };
            return Object.values(cardCounts).sort((a, b) => (rarityOrder[b.rarity] - rarityOrder[a.rarity]) || a.name.localeCompare(b.name));
        }

        function displayInventory() {
            inventoryStatus.textContent = `${playerInventory.length} / ${inventoryCapacity}`;
            inventoryContainer.innerHTML = '';
            const uniqueCards = getUniqueInventory();
            if (uniqueCards.length === 0) {
                inventoryContainer.innerHTML = `<p class="col-span-full text-center text-gray-400 mt-10">ì•„ì§ ìˆ˜ì§‘í•œ ë™ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>`; return;
            }
            uniqueCards.forEach((character, index) => {
                inventoryContainer.appendChild(createCard(character, { animationIndex: index, isInventory: true }));
            });
        }

        function displayDeckManagement() {
            deckStatus.textContent = `í˜„ì¬ ë±: ${playerDeck.length} / ${DECK_CAPACITY}`;
            deckStatus.classList.toggle('text-green-400', playerDeck.length === DECK_CAPACITY);
            deckSlotsContainer.innerHTML = '';
            for (let i = 0; i < DECK_CAPACITY; i++) {
                if (playerDeck[i]) {
                    deckSlotsContainer.appendChild(createCard(playerDeck[i], { isDeckSlot: true }));
                } else {
                    const emptySlot = document.createElement('div');
                    emptySlot.className = 'deck-slot rounded-lg'; emptySlot.textContent = 'ë¹„ì–´ìˆìŒ';
                    deckSlotsContainer.appendChild(emptySlot);
                }
            }
            deckInventoryContainer.innerHTML = '';
            const uniqueCards = getUniqueInventory();
             if (uniqueCards.length === 0) {
                deckInventoryContainer.innerHTML = `<p class="col-span-full text-center text-gray-400 mt-10">ë±ì— ì¶”ê°€í•  ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>`; return;
            }
            uniqueCards.forEach((character, index) => {
                const isCardInDeck = playerDeck.some(deckCard => deckCard.name === character.name);
                const isDeckFull = playerDeck.length >= DECK_CAPACITY;
                deckInventoryContainer.appendChild(createCard(character, { animationIndex: index, isDeckBuilder: true, isCardInDeck, isDeckFull }));
            });
        }
        
        function autoFillDeck() {
            const uniqueCards = getUniqueInventory();
            const sortedByPower = uniqueCards.sort((a, b) => b.power - a.power);
            playerDeck = sortedByPower.slice(0, DECK_CAPACITY);
            displayDeckManagement();
            showMessage('ê°€ì¥ ê°•ë ¥í•œ ì¹´ë“œë¡œ ë±ì„ ìë™ í¸ì„±í–ˆìŠµë‹ˆë‹¤!', 'text-blue-300', messageArea);
            saveGame();
        }

        function addToDeck(cardName) {
            if (playerDeck.length >= DECK_CAPACITY || playerDeck.some(card => card.name === cardName)) return;
            const cardToAdd = characters.find(card => card.name === cardName);
            if (cardToAdd) { playerDeck.push(cardToAdd); displayDeckManagement(); saveGame(); }
        }
        
        function removeFromDeck(cardName) {
            playerDeck = playerDeck.filter(card => card.name !== cardName);
            displayDeckManagement();
            saveGame();
        }
        
        function calculateDeckPower() {
            return playerDeck.reduce((total, card) => total + (card.power || 0), 0);
        }

        function displayCombatView() {
            deckPowerDisplay.textContent = calculateDeckPower();
            dungeonListContainer.innerHTML = '';
            dungeons.forEach((dungeon, index) => {
                const dungeonEl = document.createElement('div');
                dungeonEl.className = 'bg-black/20 p-4 rounded-lg text-center';
                dungeonEl.innerHTML = `
                    <h3 class="text-xl font-bold text-yellow-300">${dungeon.name}</h3>
                    <p class="text-gray-300">ê¶Œì¥ ì „íˆ¬ë ¥: ${dungeon.recommendedPower}</p>
                    <p class="text-gray-300">ì˜ˆìƒ ë³´ìƒ: ğŸ’${dungeon.rewards.min} ~ ${dungeon.rewards.max}</p>
                    <button data-action="challenge-dungeon" data-dungeon-index="${index}" class="gacha-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full mt-4">ë„ì „</button>
                `;
                dungeonListContainer.appendChild(dungeonEl);
            });
        }
        
        function challengeDungeon(dungeonIndex) {
            if (playerDeck.length < DECK_CAPACITY) {
                showMessage('ë±ì„ 5ì¥ìœ¼ë¡œ ëª¨ë‘ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤!', 'text-yellow-400', combatMessageArea);
                return;
            }
            
            const dungeon = dungeons[dungeonIndex];
            const deckPower = calculateDeckPower();
            
            if (deckPower < dungeon.recommendedPower) {
                if (Math.random() < 0.3) {
                    const earnedReward = dungeon.rewards.min;
                    playerCurrency += earnedReward;
                    showMessage(`ê¸°ì ! ì•½ì„¸ë¥¼ ê·¹ë³µí•˜ê³  ìŠ¹ë¦¬! ğŸ’${earnedReward} íšë“!`, 'text-green-300', combatMessageArea);
                } else {
                    const penalty = dungeon.rewards.min;
                    playerCurrency = Math.max(0, playerCurrency - penalty);
                    showMessage(`ì „íˆ¬ íŒ¨ë°°... ğŸ’${penalty}ë¥¼ ìƒì—ˆìŠµë‹ˆë‹¤.`, 'text-red-400', combatMessageArea);
                }
            } else {
                let powerRatio = Math.min(deckPower / dungeon.recommendedPower, 1.5);
                let rewardRange = dungeon.rewards.max - dungeon.rewards.min;
                let earnedReward = dungeon.rewards.min + Math.floor(rewardRange * powerRatio * Math.random());
                earnedReward = Math.min(earnedReward, dungeon.rewards.max * 2);

                playerCurrency += earnedReward;
                showMessage(`íƒí—˜ ì„±ê³µ! ğŸ’${earnedReward} íšë“!`, 'text-green-300', combatMessageArea);
            }
            updateUI();
            saveGame();
        }

        function createCard(character, options = {}) {
            const { animationIndex, isDeckSlot, isDeckBuilder, isInventory, isCardInDeck, isDeckFull } = options;
            const card = document.createElement('div');
            card.className = `rarity-${character.rarity} relative text-center rounded-lg shadow-md p-2 transform transition-transform duration-300 hover:scale-105`;
            const rarityColor = { 'N': 'text-gray-600', 'R': 'text-blue-800', 'SR': 'text-white', 'SSR': 'text-black' }[character.rarity];
            
            let badgeHTML = character.count > 1 ? `<div class="count-badge">x${character.count}</div>` : '';
            if(isDeckSlot) badgeHTML = '';

            let actionButtonsHTML = '';
            if (isDeckBuilder) {
                const disabled = isDeckFull || isCardInDeck;
                const buttonText = isCardInDeck ? 'ì¶”ê°€ë¨' : 'ì¶”ê°€';
                const buttonColor = disabled ? 'bg-gray-500' : 'bg-green-500 hover:bg-green-600';
                actionButtonsHTML = `<button data-action="add-to-deck" data-card-name="${character.name}" class="w-full mt-2 py-1 rounded-md text-white font-bold text-sm ${buttonColor}" ${disabled ? 'disabled' : ''}>${buttonText}</button>`;
            } else if (isInventory) {
                 const isRepresentative = representativeCharacter && representativeCharacter.name === character.name;
                 const repButtonText = isRepresentative ? 'ëŒ€í‘œ' : 'ëŒ€í‘œ ì„¤ì •';
                 const repButtonColor = isRepresentative ? 'bg-yellow-500' : 'bg-gray-600 hover:bg-gray-700';
                 actionButtonsHTML = `<button data-action="set-representative" data-card-name="${character.name}" class="w-full mt-2 py-1 rounded-md text-white font-bold text-sm ${repButtonColor}" ${isRepresentative ? 'disabled' : ''}>${repButtonText}</button>`;
            }
            
            let deckSlotButton = '';
            if(isDeckSlot) {
                 deckSlotButton = `<button data-action="remove-from-deck" data-card-name="${character.name}" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 text-sm font-bold flex items-center justify-center z-10">X</button>`;
            }


            card.innerHTML = `
                ${badgeHTML} ${deckSlotButton}
                <div class="relative pointer-events-none">
                    <img src="${character.cardImageUrl}" alt="${character.name}" class="w-full h-auto rounded-md mb-2 border-2 border-white/50">
                    <p class="font-bold text-sm ${rarityColor} truncate">${character.name}</p>
                    <p class="font-black text-lg ${rarityColor}" style="text-shadow: 1px 1px 2px rgba(255,255,255,0.5);">${character.rarity}</p>
                </div>
                 ${actionButtonsHTML}
            `;
            if (typeof animationIndex === 'number') {
                card.style.opacity = '0';
                card.style.animationDelay = `${animationIndex * 0.05}s`;
                card.classList.add('card-animation');
            }
            if(isDeckBuilder && isCardInDeck) {
                card.classList.add('opacity-50');
            }
            return card;
        }

        // --- ê²Œì„ ì‹œì‘ ---
        loadGame();
    </script>
</body>
</html>



<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kside_</title>
    <!-- Tailwind CSSë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹ ë¥´ê³  ë©‹ì§„ ë””ìì¸ì„ ì ìš©í•©ë‹ˆë‹¤ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì‚¬ìš©ì ì •ì˜ ì• ë‹ˆë©”ì´ì…˜ ë° ìŠ¤íƒ€ì¼ */
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
        body {
            font-family: 'Jua', sans-serif;
            background-image: linear-gradient(to top, #30cfd0 0%, #330867 100%);
        }

        /* ì¹´ë“œê°€ ë‚˜íƒ€ë‚  ë•Œì˜ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .card-animation { animation: fadeIn 0.5s ease-out forwards; }

        /* ë“±ê¸‰ë³„ ì¹´ë“œ ë°°ê²½ ê·¸ë¼ë°ì´ì…˜ */
        .rarity-N { background-image: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%); }
        .rarity-R { background-image: linear-gradient(to top, #a1c4fd 0%, #c2ebf0 100%); }
        .rarity-SR { background-image: linear-gradient(to right, #f83292, #7122fa); }
        .rarity-SSR { background-image: linear-gradient(to right, #f78ca0 0%, #f9748f 19%, #fd868c 60%, #fe9a8b 100%); }

        /* ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
        .gacha-button { transition: all 0.3s ease; }
        .gacha-button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); }
        
        /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button.active { background-color: #f6e05e; color: #330867; }
        
        /* ì¹´ë“œ ê°œìˆ˜ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .count-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #e53e3e;
            color: white;
            font-size: 14px;
            font-weight: bold;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        /* ë± ìŠ¬ë¡¯ ìŠ¤íƒ€ì¼ */
        .deck-slot {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
        }
        /* í™ˆ í™”ë©´ ìºë¦­í„° ì´ë¯¸ì§€ */
        #home-character-image {
            max-height: 60vh;
            object-fit: contain;
            filter: drop-shadow(0px 5px 15px rgba(0,0,0,0.5));
            transition: transform 0.3s ease-in-out;
        }
        #home-character-image:hover {
            transform: scale(1.03);
        }
        /* ì´ë²¤íŠ¸ ë°°ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 255, 100, 0.4); }
            50% { box-shadow: 0 0 25px rgba(255, 255, 100, 0.8); }
        }
        #event-banner {
            animation: pulse-glow 2.5s infinite ease-in-out;
        }
        /* ë½‘ê¸° íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .sub-tab-button { transition: all 0.2s ease-in-out; }
        .sub-tab-button.active { background-color: rgba(246, 224, 94, 0.8); color: #330867; }
        
        /* ì „íˆ¬ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #combat-log { scroll-behavior: smooth; }
        .hp-bar-background { background-color: #4a5568; }
        .hp-bar-foreground { background-color: #48bb78; transition: width 0.5s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake-animation { animation: shake 0.3s 1; }
        .speed-button.active {
            background-color: #4299e1; /* blue-500 */
            box-shadow: 0 0 10px rgba(66, 153, 225, 0.7);
        }
        .story-content {
            white-space: pre-wrap;
            word-break: keep-all;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-5xl bg-white/10 backdrop-blur-md rounded-2xl shadow-xl text-white p-6 md:p-8">
        
        <!-- ì œëª© ë¶€ë¶„ -->
        <header class="text-center mb-4">
            <h1 class="text-4xl md:text-5xl font-bold tracking-wider text-yellow-300" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Kside_</h1>
        </header>

        <!-- ì¬í™” ë° íƒ­ ë©”ë‰´ ì˜ì—­ -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
            <div class="bg-black/20 rounded-full p-1 flex-shrink-0 flex flex-wrap justify-center">
                <button id="tab-home" class="tab-button active font-bold py-2 px-6 rounded-full">í™ˆ</button>
                <button id="tab-event" class="tab-button font-bold py-2 px-6 rounded-full hidden">ì´ë²¤íŠ¸</button>
                <button id="tab-gacha" class="tab-button font-bold py-2 px-6 rounded-full">ëˆ„êµ°ê°€ì˜ ì„œê³ </button>
                <button id="tab-inventory" class="tab-button font-bold py-2 px-6 rounded-full">ë‹¹ì‹ ì˜ ì±…ì¥</button>
                <button id="tab-deck" class="tab-button font-bold py-2 px-6 rounded-full">í¸ì°¬</button>
                <button id="tab-combat" class="tab-button font-bold py-2 px-6 rounded-full">ë…ì„œ</button>
                <button id="tab-story" class="tab-button font-bold py-2 px-6 rounded-full">ìŠ¤í† ë¦¬</button>
                <button id="tab-collection" class="tab-button font-bold py-2 px-6 rounded-full">ë„ê°</button>
                <button id="tab-achievements" class="tab-button font-bold py-2 px-6 rounded-full">ì—…ì </button>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-xl font-bold text-cyan-300 bg-black/20 py-2 px-4 rounded-full inline-block">ğŸ”– <span id="bookmark-display">10</span> / <span id="max-bookmark-display">10</span><span id="bookmark-timer-container" class="text-sm ml-2"></span></div>
				<div class="text-xl font-bold text-gray-300 bg-black/20 py-2 px-4 rounded-full inline-block">ğŸ–Šï¸ <span id="pen-display">0</span></div>
                <div class="text-2xl font-bold text-yellow-300 bg-black/20 py-2 px-6 rounded-full inline-block">ğŸ’ <span id="currency-display">100</span></div>
                <button id="reset-game" class="gacha-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full text-sm">ì´ˆê¸°í™”</button>
            </div>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
        <main>
             <!-- ì €ì¥ ë¶ˆê°€ ê²½ê³  ë©”ì‹œì§€ -->
            <div id="storage-warning" class="hidden text-center bg-red-500 p-2 rounded-lg mb-4">
                <strong>ê²½ê³ :</strong> ê²Œì„ ì§„í–‰ ìƒí™©ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ê°€ ì‹œí¬ë¦¿ ëª¨ë“œì´ê±°ë‚˜ ì €ì¥ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.
            </div>

            <!-- í™ˆ í™”ë©´ -->
            <div id="home-view">
                <div class="relative min-h-[50vh] flex flex-col justify-center items-center text-center p-4">
                    <!-- ì´ë²¤íŠ¸ ë°°ë„ˆ -->
                    <div id="event-banner" class="hidden absolute top-4 right-4 bg-gradient-to-r from-yellow-400 via-red-500 to-pink-500 p-4 rounded-lg shadow-lg cursor-pointer transform hover:scale-105 transition-transform duration-300 z-10">
                        <h3 class="text-white text-lg font-bold drop-shadow-md">ê¸°ê°„ í•œì • ì´ë²¤íŠ¸!</h3>
                        <p id="event-banner-text" class="text-white text-sm drop-shadow-md"></p>
                    </div>

                    <div id="home-character-container" class="flex-grow flex items-center justify-center cursor-pointer">
                        <img id="home-character-image" src="" alt="ëŒ€í‘œ ìºë¦­í„°" class="max-w-full">
                    </div>
                    <div id="home-dialogue-container" class="w-full max-w-2xl bg-black/30 backdrop-blur-sm p-4 rounded-xl mt-4">
                        <p id="home-character-name" class="font-bold text-lg text-yellow-300"></p>
                        <p id="home-character-dialogue" class="text-white"></p>
                    </div>
                     <div id="home-default-message" class="text-2xl text-gray-300">
                        ë³´ê´€í•¨ì—ì„œ ëŒ€í‘œ ë“±ì¥ì¸ë¬¼ì„ ì„¤ì •í•´ì£¼ì„¸ìš”!
                    </div>
                </div>
            </div>
            
            <!-- ì´ë²¤íŠ¸ í™”ë©´ -->
            <div id="event-view" class="hidden">
				
                 <div class="bg-black/20 rounded-full p-1 flex justify-center items-center mb-4 max-w-md mx-auto">
                    <button id="event-sub-tab-battle" class="sub-tab-button active w-1/3 font-bold py-2 px-4 rounded-full">ì „íˆ¬</button>
                    <button id="event-sub-tab-story" class="sub-tab-button w-1/3 font-bold py-2 px-4 rounded-full">ìŠ¤í† ë¦¬</button>
                    <button id="event-sub-tab-shop" class="sub-tab-button w-1/3 font-bold py-2 px-4 rounded-full">ìƒì </button>
                </div>

				<div class="flex justify-center mb-4">
                    <div id="event-point-display" class="hidden text-xl font-bold text-pink-300 bg-black/20 py-2 px-4 rounded-full">EVENT P: <span id="event-points">0</span></div>
                </div>
				
                <div id="event-battle-view">
                    <p class="text-center text-gray-200 mb-4">ì´ë²¤íŠ¸ ìŠ¤í…Œì´ì§€ì— ë„ì „í•˜ì—¬ ì´ë²¤íŠ¸ í¬ì¸íŠ¸ë¥¼ íšë“í•˜ì„¸ìš”!</p>
                    <div id="event-dungeon-list-container" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
                </div>
                <div id="event-story-view" class="hidden">
                    <p class="text-center text-gray-200 mb-4">ì´ë²¤íŠ¸ ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í•˜ê³  ìŠ¤í† ë¦¬ë¥¼ í•´ê¸ˆí•˜ì„¸ìš”.</p>
                    <div id="event-story-container" class="space-y-3 max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl"></div>
                </div>
                <div id="event-shop-view" class="hidden">
                    <p class="text-center text-gray-200 mb-4">íšë“í•œ ì´ë²¤íŠ¸ í¬ì¸íŠ¸ë¡œ íŠ¹ë³„í•œ ë³´ìƒì„ êµí™˜í•˜ì„¸ìš”!</p>
                    <div id="event-shop-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>

            <!-- ë½‘ê¸° í™”ë©´ -->
            <div id="gacha-view" class="hidden">
                <p class="text-center text-gray-200 mt-2 mb-4">ìš´ëª…ì„ ì‹œí—˜í•˜ì—¬ ë‹¹ì‹ ì˜ ë“±ì¥ì¸ë¬¼ì„ ë§Œë‚˜ë³´ì„¸ìš”.</p>
                <div class="bg-black/20 rounded-full p-1 flex justify-center items-center mb-4 max-w-sm mx-auto">
                    <button id="gacha-tab-normal" class="sub-tab-button active w-1/2 font-bold py-2 px-6 rounded-full">ì¼ë°˜ ë½‘ê¸°</button>
                    <button id="gacha-tab-event" class="sub-tab-button w-1/2 font-bold py-2 px-6 rounded-full hidden">ì´ë²¤íŠ¸ ë½‘ê¸°</button>
                </div>
                <div id="normal-gacha-view">
					<div class="bg-black/20 p-3 rounded-lg text-center mb-4 max-w-md mx-auto">
                        <p class="font-bold text-yellow-300 mb-2">ë“±ê¸‰ë³„ ë“±ì¥ í™•ë¥ </p>
                        <div class="flex justify-center gap-4">
                            <p class="text-sm">SSR: <span class="font-bold">3%</span></p>
                            <p class="text-sm">SR: <span class="font-bold">12%</span></p>
                            <p class="text-sm">R: <span class="font-bold">35%</span></p>
                            <p class="text-sm">N: <span class="font-bold">50%</span></p>
                        </div>
					</div>
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-4">
                        <button id="pull-one" class="gacha-button w-full sm:w-auto bg-blue-500 hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">ğŸ’ 1íšŒ ë½‘ê¸° (10)</button>
                        <button id="pull-ten" class="gacha-button w-full sm:w-auto bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">ğŸ’ğŸ’ 10íšŒ ë½‘ê¸° (100)</button>
                    </div>
                </div>
                <div id="event-gacha-view" class="hidden">
                    <div id="event-gacha-info" class="text-center p-2 mb-2 rounded-lg bg-yellow-500/20">
                        <p class="font-bold text-yellow-300"></p>
                    </div>
					<div class="bg-black/20 p-3 rounded-lg text-center mb-4 max-w-md mx-auto">
                        <p class="font-bold text-yellow-300 mb-2">ë“±ê¸‰ë³„ ë“±ì¥ í™•ë¥ </p>
                        <div class="flex justify-center gap-4">
                            <p class="text-sm">SSR: <span class="font-bold">6%</span></p>
                            <p class="text-sm">SR: <span class="font-bold">14%</span></p>
                            <p class="text-sm">R: <span class="font-bold">30%</span></p>
                            <p class="text-sm">N: <span class="font-bold">50%</span></p>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-4">
                        <button id="pull-one-event" class="gacha-button w-full sm:w-auto bg-gradient-to-r from-red-500 to-yellow-500 hover:from-red-600 hover:to-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">ğŸ”¥ 1íšŒ ë½‘ê¸° (10)</button>
                        <button id="pull-ten-event" class="gacha-button w-full sm:w-auto bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">ğŸ”¥ğŸ”¥ 10íšŒ ë½‘ê¸° (100)</button>
                    </div>
                </div>
                <div id="message-area" class="text-center text-lg h-8 mb-4 transition-opacity duration-300"></div>
                <div id="results-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[200px] bg-black/20 p-4 rounded-xl"></div>
            </div>

            <!-- ë³´ê´€í•¨ í™”ë©´ -->
            <div id="inventory-view" class="hidden">
                 <div class="text-center mb-4">
                    <p class="text-gray-200">ì§€ê¸ˆê¹Œì§€ ìˆ˜ì§‘í•œ ë“±ì¥ì¸ë¬¼ì…ë‹ˆë‹¤.</p>
                    <div class="mt-2 flex justify-center items-center gap-4">
                        <p id="inventory-status" class="text-lg font-bold bg-black/20 py-2 px-4 rounded-full"></p>
                        <button id="expand-inventory" class="gacha-button bg-yellow-500 hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed text-black font-bold py-2 px-4 rounded-full shadow-lg text-sm">ì¹¸ í™•ì¥ (ğŸ’50)</button>
                    </div>
                </div>
                <div id="inventory-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[400px] max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl"></div>
            </div>

            <!-- ë± ê´€ë¦¬ í™”ë©´ -->
            <div id="deck-view" class="hidden">
                <div class="text-center mb-4">
                    <p class="text-gray-200">ë“±ì¥ì¸ë¬¼ë“¤ê³¼ í•¨ê»˜ ë…ì„œë¥¼ ì¤€ë¹„í•˜ì„¸ìš”. (5ì¥ í•„ìˆ˜)</p>
                    <div class="mt-2 flex justify-center items-center gap-4">
                        <div id="deck-status" class="text-lg font-bold text-yellow-300"></div>
                        <button id="auto-fill-deck" class="gacha-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg text-sm">ìë™ í¸ì„±</button>
                    </div>
                </div>
                <div id="deck-slots-container" class="grid grid-cols-5 gap-4 mb-6 bg-black/20 p-4 rounded-xl"></div>
                <div class="text-center mb-4">
                    <h3 class="text-lg font-bold text-yellow-300">í™œì„± ì¸ì—° íš¨ê³¼</h3>
                    <div id="synergy-list" class="mt-2 text-gray-200 text-sm min-h-[24px]">
                        </div>
                </div>
				<div id="deck-inventory-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[250px] max-h-[40vh] overflow-y-auto bg-black/20 p-4 rounded-xl"></div>
            </div>
            
            <!-- ì „íˆ¬ í™”ë©´ (ë˜ì „ ì„ íƒ) -->
            <div id="combat-view" class="hidden">
                <div class="text-center mb-4">
                    <p class="text-gray-200">í¸ì°¬í•œ ì±…ìœ¼ë¡œ ë…ì„œì— ë„ì „í•˜ì—¬ ë³´ìƒì„ íšë“í•˜ì„¸ìš”!</p>
                    <p class="text-xl font-bold">í˜„ì¬ ì±… ì „íˆ¬ë ¥: <span id="deck-power-display" class="text-yellow-300">0</span></p>
                </div>
				
            <div id="dungeon-volume-selection">
                </div>
            <div id="dungeon-stage-selection" class="hidden">
                <button id="back-to-volume-selection" class="gacha-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full mb-4">â† ë’¤ë¡œê°€ê¸°</button>
                <h3 id="current-volume-title" class="text-2xl font-bold text-center mb-4"></h3>
                <div id="stage-list-container" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
            </div>
            </div>

            <!-- ì „íˆ¬ ì§„í–‰ í™”ë©´ -->
            <div id="combat-in-progress-view" class="hidden">
                <div class="grid grid-cols-3 gap-4 items-center">
                    <!-- Player Deck -->
                    <div id="combat-player-deck" class="col-span-1 space-y-2"></div>
                    <!-- Monster -->
                    <div id="combat-monster-area" class="col-span-2 flex flex-col items-center"></div>
                </div>

                <div class="flex justify-end items-center gap-2 mt-4">
                    <button id="speed-1x" class="speed-button active bg-gray-600 text-white font-bold py-1 px-3 rounded-full text-sm">1x</button>
                    <button id="speed-2x" class="speed-button bg-gray-600 text-white font-bold py-1 px-3 rounded-full text-sm">2x</button>
                    <button id="speed-4x" class="speed-button bg-gray-600 text-white font-bold py-1 px-3 rounded-full text-sm">4x</button>
                </div>
                <div id="combat-log-container" class="mt-2 bg-black/30 p-4 rounded-lg h-40 overflow-y-auto">
                    <div id="combat-log"></div>
                </div>
                 <div id="combat-result-modal" class="hidden absolute inset-0 bg-black/70 flex justify-center items-center z-20">
                    <div class="bg-gray-800 p-8 rounded-lg text-center">
                        <h2 id="combat-result-title" class="text-4xl font-bold mb-4"></h2>
                        <p id="combat-result-message" class="text-lg mb-6"></p>
                        <button id="close-combat-result" class="gacha-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">í™•ì¸</button>
                    </div>
                </div>
            </div>

             <!-- ë„ê° í™”ë©´ -->
            <div id="collection-view" class="hidden">
                <div class="text-center mb-4">
                    <p class="text-gray-200">ìˆ˜ì§‘í•œ ë“±ì¥ì¸ë¬¼ê³¼ ì•„ì§ ë§Œë‚˜ì§€ ëª»í•œ ë“±ì¥ì¸ë¬¼ì„ í™•ì¸í•˜ì„¸ìš”.</p>
                </div>
                <div id="collection-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[400px] max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl">
                </div>
            </div>
            
            <!-- ìŠ¤í† ë¦¬ í™”ë©´ -->
            <div id="story-view" class="hidden">
                <div class="text-center mb-4">
                    <p class="text-gray-200">ë…ì„œë¥¼ í†µí•´ ë©”ì¸ ìŠ¤í† ë¦¬ë¥¼ í•´ê¸ˆí•˜ì„¸ìš”.</p>
                </div>
			
                <div id="main-story-container" class="space-y-3 max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl">
                </div>
            </div>

             <div id="achievements-view" class="hidden">
                <div class="text-center mb-4">
                    <p class="text-gray-200">ë‹¤ì–‘í•œ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê³  íŠ¹ë³„í•œ ë³´ìƒì„ íšë“í•˜ì„¸ìš”.</p>
                </div>
                <div id="achievements-container" class="space-y-3 max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl">
                    </div>
            </div>

            <div id="toast-notification" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-yellow-400 text-black font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 z-50">
                ğŸ‰ ì—…ì  ë‹¬ì„±!
            </div>


            <!-- ì¹´ë“œ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
            <div id="card-detail-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-30">
                <div class="bg-gray-800 p-6 rounded-lg max-w-lg w-full relative mx-4 max-h-[90vh] overflow-y-auto">
                    <button id="close-card-detail" class="absolute top-3 right-4 text-white text-3xl font-bold hover:text-gray-400">&times;</button>
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="md:w-1/3">
                            <img id="detail-card-image" src="" alt="Card Image" class="w-full rounded-lg shadow-lg">
                        </div>
                        <div class="md:w-2/3">
                            <h2 id="detail-card-name" class="text-3xl font-bold"></h2>
                            <div class="flex items-center gap-4 mb-4">
                                <p id="detail-card-rarity" class="font-bold text-2xl"></p>
                                <p id="detail-card-faction" class="font-bold text-lg px-3 py-1 rounded-full"></p>
                            </div>
                            <div class="bg-black/20 p-3 rounded-lg mb-4">
                                <h3 class="font-bold text-lg mb-2 text-yellow-300">ëŠ¥ë ¥ì¹˜</h3>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div><p class="text-sm text-gray-400">HP</p><p id="detail-stat-hp" class="font-bold text-lg"></p></div>
                                    <div><p class="text-sm text-gray-400">ATK</p><p id="detail-stat-atk" class="font-bold text-lg"></p></div>
                                    <div><p class="text-sm text-gray-400">DEF</p><p id="detail-stat-def" class="font-bold text-lg"></p></div>
                                </div>
                            </div>
							
							<div class="bg-black/20 p-3 rounded-lg mb-4">
								<h3 class="font-bold text-lg mb-2 text-yellow-300">ê°•í™”</h3>
								<div id="enhancement-ui" class="flex items-center justify-between">
									<div>
										<p>í˜„ì¬: <span id="detail-enhancement-level" class="font-bold text-xl"></span></p>
										<p class="text-sm">ë¹„ìš©: ğŸ–Šï¸ <span id="detail-enhancement-cost"></span></p>
									</div>
									<button id="detail-enhancement-button" class="gacha-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full disabled:opacity-50 disabled:bg-gray-600">ê°•í™”</button>
								</div>
								<p id="max-enhancement-text" class="hidden text-center font-bold text-green-400 mt-2">ìµœëŒ€ ë ˆë²¨ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!</p>
							</div>
						
                             <div class="bg-black/20 p-3 rounded-lg">
                                <h3 class="font-bold text-lg mb-2 text-yellow-300">ìŠ¤í‚¬</h3>
                                <div id="detail-skills-container" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                    <div id="detail-card-story-container" class="mt-4 bg-black/20 p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-2 text-yellow-300">ë“±ì¥ì¸ë¬¼ ìŠ¤í† ë¦¬</h3>
                        <div id="detail-card-story" class="text-gray-300 text-sm story-content h-24 overflow-y-auto"></div>
                        <div id="detail-story-pagination" class="flex justify-center items-center mt-2">
                            <button id="detail-story-prev" class="gacha-button text-white font-bold py-1 px-4 rounded-full text-sm">&lt; ì´ì „</button>
                            <span id="detail-story-page-indicator" class="mx-4 text-sm"></span>
                            <button id="detail-story-next" class="gacha-button text-white font-bold py-1 px-4 rounded-full text-sm">ë‹¤ìŒ &gt;</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ë©”ì¸ ìŠ¤í† ë¦¬ ëª¨ë‹¬ -->
            <div id="interactive-story-modal" class="hidden fixed inset-0 bg-black/50 flex flex-col justify-end z-40">
                <div id="story-character-display" class="absolute inset-0 flex justify-center md:justify-between items-end md:px-10 overflow-hidden">
                    <img id="story-char-left" src="" class="h-2/3 md:h-5/6 object-contain transition-opacity duration-300 opacity-0">
                    <img id="story-char-right" src="" class="h-2/3 md:h-5/6 object-contain transition-opacity duration-300 opacity-0">
                </div>
                
                <div id="dialogue-box" class="relative bg-black/70 backdrop-blur-sm m-4 p-5 rounded-xl border border-white/20 text-white z-10">
                    <h3 id="speaker-name" class="font-bold text-2xl text-yellow-300 mb-2"></h3>
                    <p id="dialogue-text" class="text-lg leading-relaxed h-24"></p>
                    <button id="story-next-button" class="absolute bottom-4 right-5 text-xl animate-pulse">â–¼ ë‹¤ìŒ</button>
                </div>
                 <button id="story-skip-button" class="absolute top-5 right-5 bg-black/50 text-white py-2 px-4 rounded-full z-20">ìŠ¤í‚µ</button>
            </div>
		 </div> <div id="enhancement-success-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
            <div class="bg-gray-800 p-8 rounded-lg text-center max-w-md w-full mx-4">
                <h2 class="text-3xl font-bold mb-4 text-yellow-300">ğŸ‰ ê°•í™” ì„±ê³µ! ğŸ‰</h2>
                <p id="enhancement-success-card-name" class="text-xl mb-4"></p>
                <div class="bg-black/30 p-4 rounded-lg">
                    <p id="enhancement-success-dialogue" class="text-lg italic"></p>
                </div>
                <button id="close-enhancement-success" class="gacha-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full mt-6">í™•ì¸</button>
            </div>
        </div>
        </main>
    </div>

	
	<script src="game_data.js"></script>
	
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            

            // --- ê²Œì„ ìƒíƒœ ---
            let playerCurrency = 100;
            let playerInventory = [];
            let playerDeck = [];
            let inventoryCapacity = 100;
            let representativeCharacter = null;
            let isCombatRunning = false;
            let combatSpeedMultiplier = 1;
            let lastCombatType = 'main'; // ë§ˆì§€ë§‰ ì „íˆ¬ ìœ í˜•ì„ ì €ì¥í•©ë‹ˆë‹¤.
            let clearedDungeons = [];
            let clearedEventDungeons = [];
            let playerEventPoints = 0;
            let purchasedEventItems = {};
            let currentStoryPages = [];
            let currentStoryPageIndex = 0;
            let playerBookmarks = 10;
            const MAX_BOOKMARKS = 10;
            let lastBookmarkUpdateTime = Date.now();
            const BOOKMARK_REGEN_TIME = 5 * 60 * 1000; // 5 minutes
            let playerAchievements = {}; // { ach_001: 'unlocked' | 'claimed' }
            let playerStats = { totalPulls: 0 };
			let clearedStages = {}; // { 'ì´ˆë³´ìì˜ ìˆ²': [0, 1, 2], ... } í˜•ì‹ <-- ì´ ì¤„ ì¶”ê°€
			let playerPens = 0;
			let currentInteractiveStory = null; // ì´ ì¤„ ì¶”ê°€
			let currentSceneIndex = 0; // ì´ ì¤„ ì¶”ê°€

            const DECK_CAPACITY = 5;
            const PULL_ONE_COST = 10;
            const PULL_TEN_COST = 100;
            const EXPAND_COST = 50;
            const EXPAND_AMOUNT = 10;
            const SAVE_DATA_KEY = 'gachaGameSaveData_v8';

            // --- HTML ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
            const currencyDisplay = document.getElementById('currency-display');
            const messageArea = document.getElementById('message-area');
            const allTabs = document.querySelectorAll('.tab-button');
            const allViews = document.querySelectorAll('main > div:not(#combat-result-modal):not(#card-detail-modal):not(#main-story-modal)');
            const pullOneButton = document.getElementById('pull-one');
            const pullTenButton = document.getElementById('pull-ten');
            const pullOneEventButton = document.getElementById('pull-one-event');
            const pullTenEventButton = document.getElementById('pull-ten-event');
            const resultsContainer = document.getElementById('results-container');
            const inventoryContainer = document.getElementById('inventory-container');
            const inventoryStatus = document.getElementById('inventory-status');
            const expandInventoryButton = document.getElementById('expand-inventory');
            const deckStatus = document.getElementById('deck-status');
            const deckSlotsContainer = document.getElementById('deck-slots-container');
            const deckInventoryContainer = document.getElementById('deck-inventory-container');
            const autoFillDeckButton = document.getElementById('auto-fill-deck');
            const deckPowerDisplay = document.getElementById('deck-power-display');
            const combatMessageArea = document.getElementById('combat-message-area');
            const dungeonListContainer = document.getElementById('dungeon-list-container');
            const homeCharacterContainer = document.getElementById('home-character-container');
            const homeCharacterImage = document.getElementById('home-character-image');
            const homeDialogueContainer = document.getElementById('home-dialogue-container');
            const homeDefaultMessage = document.getElementById('home-default-message');
            const homeCharacterName = document.getElementById('home-character-name');
            const homeCharacterDialogue = document.getElementById('home-character-dialogue');
            const eventBanner = document.getElementById('event-banner');
            const eventBannerText = document.getElementById('event-banner-text');
            const gachaTabNormal = document.getElementById('gacha-tab-normal');
            const gachaTabEvent = document.getElementById('gacha-tab-event');
            const normalGachaView = document.getElementById('normal-gacha-view');
            const eventGachaView = document.getElementById('event-gacha-view');
            const eventGachaInfo = document.getElementById('event-gacha-info');
            const resetButton = document.getElementById('reset-game');
            const storageWarning = document.getElementById('storage-warning');
            const combatInProgressView = document.getElementById('combat-in-progress-view');
            const combatPlayerDeck = document.getElementById('combat-player-deck');
            const combatMonsterArea = document.getElementById('combat-monster-area');
            const combatLogContainer = document.getElementById('combat-log-container');
            const combatLog = document.getElementById('combat-log');
            const combatResultModal = document.getElementById('combat-result-modal');
            const combatResultTitle = document.getElementById('combat-result-title');
            const combatResultMessage = document.getElementById('combat-result-message');
            const closeCombatResultButton = document.getElementById('close-combat-result');
            const cardDetailModal = document.getElementById('card-detail-modal');
            const closeCardDetailButton = document.getElementById('close-card-detail');
            const speed1xButton = document.getElementById('speed-1x');
            const speed2xButton = document.getElementById('speed-2x');
            const speed4xButton = document.getElementById('speed-4x');
            const collectionContainer = document.getElementById('collection-container');
            const mainStoryContainer = document.getElementById('main-story-container');
            const eventTab = document.getElementById('tab-event');
            const eventPointDisplay = document.getElementById('event-point-display');
            const eventPointsSpan = document.getElementById('event-points');
            const eventSubTabBattle = document.getElementById('event-sub-tab-battle');
            const eventSubTabStory = document.getElementById('event-sub-tab-story');
            const eventSubTabShop = document.getElementById('event-sub-tab-shop');
            const eventBattleView = document.getElementById('event-battle-view');
            const eventStoryView = document.getElementById('event-story-view');
            const eventShopView = document.getElementById('event-shop-view');
            const eventDungeonListContainer = document.getElementById('event-dungeon-list-container');
            const eventStoryContainer = document.getElementById('event-story-container');
            const eventShopContainer = document.getElementById('event-shop-container');
            const bookmarkDisplay = document.getElementById('bookmark-display');
            const maxBookmarkDisplay = document.getElementById('max-bookmark-display');
            const bookmarkTimerContainer = document.getElementById('bookmark-timer-container'); 
            const achievementsContainer = document.getElementById('achievements-container'); // ì´ ì¤„ ì¶”ê°€
            const toastNotification = document.getElementById('toast-notification');
			const synergyList = document.getElementById('synergy-list'); // <-- ì´ ì¤„ ì¶”ê°€
			const interactiveStoryModal = document.getElementById('interactive-story-modal');
			const storyCharLeft = document.getElementById('story-char-left');
			const storyCharRight = document.getElementById('story-char-right');
			const speakerName = document.getElementById('speaker-name');
			const dialogueText = document.getElementById('dialogue-text');
			const storyNextButton = document.getElementById('story-next-button');
			const storySkipButton = document.getElementById('story-skip-button');
			const detailStoryPrevButton = document.getElementById('detail-story-prev');
            const detailStoryNextButton = document.getElementById('detail-story-next');
			const penDisplay = document.getElementById('pen-display');
			const dungeonVolumeSelection = document.getElementById('dungeon-volume-selection');
			const dungeonStageSelection = document.getElementById('dungeon-stage-selection');
			const backToVolumeSelectionButton = document.getElementById('back-to-volume-selection');
			const currentVolumeTitle = document.getElementById('current-volume-title');
			const stageListContainer = document.getElementById('stage-list-container');
			const enhancementSuccessModal = document.getElementById('enhancement-success-modal');
			const closeEnhancementSuccessButton = document.getElementById('close-enhancement-success');
            
            // --- ë°ì´í„° ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ ---
            function isStorageAvailable() {
                try {
                    const key = "__test_localstorage__";
                    localStorage.setItem(key, key);
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    return false;
                }
            }

            function saveGame() {
                if (!isStorageAvailable()) return;
                const saveData = {
                    currency: playerCurrency,
                    inventory: playerInventory,
                    deck: playerDeck.map(card => card ? card.name : null).filter(Boolean),
                    capacity: inventoryCapacity,
                    representative: representativeCharacter ? representativeCharacter.name : null,
                    clearedDungeons: clearedDungeons,
                    eventPoints: playerEventPoints,
                    clearedEventDungeons: clearedEventDungeons,
                    purchasedEventItems: purchasedEventItems,
                    bookmarks: playerBookmarks,
                    lastBookmarkUpdate: lastBookmarkUpdateTime,
                    achievements: playerAchievements, // ì´ ì¤„ ì¶”ê°€
                    stats: playerStats,
                };
                localStorage.setItem(SAVE_DATA_KEY, JSON.stringify(saveData));
            }

            function loadGame() {
                if (!isStorageAvailable()) {
                    storageWarning.classList.remove('hidden');
                    resetButton.disabled = true;
                    playerInventory.push(findCharacter('[í¸ì§‘ì] ìœ¤í•„ê·œ'));
                    playerInventory.push(findCharacter('[ì¡°ìˆ˜] í•œ í˜„'));
                } else {
                    const savedDataString = localStorage.getItem(SAVE_DATA_KEY);
                    if (savedDataString) {
                        try {
                            const savedData = JSON.parse(savedDataString);
                            playerCurrency = savedData.currency ?? 100;
                            playerInventory = (savedData.inventory || []).map(item => {
								if (typeof item === 'string') { // ì˜›ë‚  ë²„ì „ ë°ì´í„°(ë¬¸ìì—´) ì²˜ë¦¬
									return { id: Date.now() + Math.random(), name: item, enhancementLevel: 0 };
								}
								return item; // ìƒˆë¡œìš´ ë²„ì „ ë°ì´í„°(ê°ì²´)
							}).filter(item => findCharacter(item.name));
                            playerDeck = (savedData.deck || []).map(name => findCharacter(name)).filter(Boolean);
                            inventoryCapacity = savedData.capacity ?? 100;
                            clearedDungeons = savedData.clearedDungeons || [];
                            playerEventPoints = savedData.eventPoints ?? 0;
                            clearedEventDungeons = savedData.clearedEventDungeons || [];
                            purchasedEventItems = savedData.purchasedEventItems || {};
                            playerBookmarks = savedData.bookmarks ?? MAX_BOOKMARKS;
                            lastBookmarkUpdateTime = savedData.lastBookmarkUpdate ?? Date.now();
                            playerAchievements = savedData.achievements || {}; // ì´ ì¤„ ì¶”ê°€
                            playerStats = savedData.stats || { totalPulls: 0 };
                            if (savedData.representative) {
                                representativeCharacter = findCharacter(savedData.representative) || null;
                            }
                        } catch (e) {
                            console.error("ì €ì¥ëœ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:", e);
                            initializeNewGameData();
                        }
                    } else {
                        initializeNewGameData();
                        saveGame();
                    }
                }
                calculateOfflineRegen();
                updateUI();
                checkEventStatus();
                switchTab('home');
                checkAchievements();
            }

            function initializeNewGameData() {
                playerInventory.push(findCharacter('[í¸ì§‘ì] ìœ¤í•„ê·œ'));
                playerInventory.push(findCharacter('[ì¡°ìˆ˜] í•œ í˜„'));
                playerBookmarks = MAX_BOOKMARKS;
                lastBookmarkUpdateTime = Date.now();
            }


            function resetGame() {
                if (!isStorageAvailable()) return;
                if (resetButton.dataset.confirming === 'true') {
                    localStorage.removeItem(SAVE_DATA_KEY);
                    location.reload();
                } else {
                    resetButton.textContent = 'í™•ì¸?';
                    resetButton.dataset.confirming = 'true';
                    resetButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                    resetButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                    setTimeout(() => {
                        resetButton.textContent = 'ì´ˆê¸°í™”';
                        resetButton.dataset.confirming = 'false';
                        resetButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                        resetButton.classList.add('bg-red-600', 'hover:bg-red-700');
                    }, 3000);
                }
            }

            // --- ì—…ì  ê´€ë ¨ í•¨ìˆ˜ ---
            function showToast() {
                toastNotification.classList.remove('hidden');
                setTimeout(() => {
                    toastNotification.classList.add('hidden');
                }, 2000); // 2ì´ˆ í›„ ì‚¬ë¼ì§
            }

            function checkAchievements() {
                const currentState = {
                    inventory: playerInventory,
                    stats: playerStats,
                    clearedDungeons: clearedDungeons,
                    capacity: inventoryCapacity,
                };
                let newAchievementUnlocked = false;
                achievements.forEach(ach => {
                    // ì•„ì§ ë‹¬ì„±í•˜ì§€ ì•Šì€ ì—…ì ë§Œ ì²´í¬
                    if (!playerAchievements[ach.id]) {
                        if (ach.condition(currentState)) {
                            playerAchievements[ach.id] = 'unlocked';
                            newAchievementUnlocked = true;
                        }
                    }
                });
                if (newAchievementUnlocked) {
                    showToast();
                    // í˜„ì¬ ì—…ì  íƒ­ì„ ë³´ê³  ìˆë‹¤ë©´ UIë¥¼ ì¦‰ì‹œ ê°±ì‹ 
                    if (document.getElementById('achievements-view').classList.contains('hidden') === false) {
                        displayAchievements();
                    }
                }
            }
            
            function displayAchievements() {
                achievementsContainer.innerHTML = '';
                achievements.forEach(ach => {
                    const status = playerAchievements[ach.id]; // 'unlocked' or 'claimed' or undefined
                    const achEl = document.createElement('div');
                    achEl.className = `p-4 rounded-lg flex justify-between items-center transition-all ${status ? 'bg-white/20' : 'bg-black/30 opacity-60'}`;
                    
                    let rewardText = '';
                    if (ach.reward.currency) rewardText = `ğŸ’ ${ach.reward.currency}`;
                    if (ach.reward.bookmarks) rewardText = `ğŸ”– ${ach.reward.bookmarks}`;

                    let buttonHTML = '';
                    if (status === 'claimed') {
                        buttonHTML = `<button class="gacha-button bg-gray-600 text-white font-bold py-2 px-4 rounded-full text-sm" disabled>ë‹¬ì„± ì™„ë£Œ</button>`;
                    } else if (status === 'unlocked') {
                        buttonHTML = `<button data-ach-id="${ach.id}" class="gacha-button bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full text-sm">ë³´ìƒ ë°›ê¸°</button>`;
                    } else {
                        buttonHTML = `<button class="gacha-button bg-gray-800 text-gray-400 font-bold py-2 px-4 rounded-full text-sm" disabled>ì§„í–‰ ì¤‘</button>`;
                    }

                    achEl.innerHTML = `
                        <div>
                            <h3 class="text-lg font-bold ${status ? 'text-yellow-300' : 'text-gray-400'}">${ach.title}</h3>
                            <p class="text-sm text-gray-300">${ach.description} (ë³´ìƒ: ${rewardText})</p>
                        </div>
                        ${buttonHTML}
                    `;
                    achievementsContainer.appendChild(achEl);
                });
            }
            
            function claimAchievement(achievementId) {
                const ach = achievements.find(a => a.id === achievementId);
                if (!ach || playerAchievements[ach.id] !== 'unlocked') return;

                // ë³´ìƒ ì§€ê¸‰
                if (ach.reward.currency) playerCurrency += ach.reward.currency;
                if (ach.reward.bookmarks) playerBookmarks = Math.min(MAX_BOOKMARKS, playerBookmarks + ach.reward.bookmarks);
                
                playerAchievements[ach.id] = 'claimed'; // ìƒíƒœ ë³€ê²½
                
                updateUI();
                displayAchievements(); // UI ê°±ì‹ 
                saveGame();
            }
			
			// --- ì¸ì—°(Synergy) ê´€ë ¨ í•¨ìˆ˜ ---
            function calculateActiveSynergies(deck) {
                return synergies.filter(synergy => synergy.condition(deck));
            }

            function displaySynergies() {
                const activeSynergies = calculateActiveSynergies(playerDeck);
                if (activeSynergies.length > 0) {
                    synergyList.innerHTML = activeSynergies.map(s => `<span class="bg-black/30 px-3 py-1 rounded-full">${s.name}: ${s.description}</span>`).join(' ');
                } else {
                    synergyList.innerHTML = 'í™œì„±í™”ëœ ì¸ì—°ì´ ì—†ìŠµë‹ˆë‹¤.';
                }
            }
            
            function applySynergyBonusesToDeck(deck) {
                const activeSynergies = calculateActiveSynergies(deck);
                if (activeSynergies.length === 0) return JSON.parse(JSON.stringify(deck));

                const bonusDeck = JSON.parse(JSON.stringify(deck)); // ì›ë³¸ ë± ìˆ˜ì •ì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ê¹Šì€ ë³µì‚¬
                bonusDeck.forEach(card => {
                    activeSynergies.forEach(synergy => {
                        synergy.applyBonus(card);
                    });
                });
                return bonusDeck;
            }
			
			 function enhanceCard(cardId) {
            const cardInstance = playerInventory.find(c => c.id === cardId);
            const characterData = findCharacter(cardInstance.name);
            if (!cardInstance || cardInstance.enhancementLevel >= 9) return;

            const cost = enhancementCosts[cardInstance.enhancementLevel];
            if (playerPens < cost) {
                showMessage('ë§Œë…„í•„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'text-red-400', messageArea);
                return;
            }

            playerPens -= cost;
            cardInstance.enhancementLevel++;

            // ê°•í™” ì‹œ ìŠ¤íƒ¯ ìƒìŠ¹ (ì˜ˆ: ê¸°ë³¸ ìŠ¤íƒ¯ì˜ 5%ì”© ìƒìŠ¹)
            characterData.stats.hp = Math.round(characterData.stats.hp * 1.05);
            characterData.stats.atk = Math.round(characterData.stats.atk * 1.05);
            characterData.stats.def = Math.round(characterData.stats.def * 1.05);

            showMessage(`${characterData.name} +${cardInstance.enhancementLevel} ê°•í™” ì„±ê³µ!`, 'text-green-300', messageArea);

            if (cardInstance.enhancementLevel === 9) {
                // 9ê°• ì„±ê³µ ì‹œ íŠ¹ë³„ ëª¨ë‹¬ í‘œì‹œ
                document.getElementById('enhancement-success-card-name').textContent = `${characterData.name} [+9]`;
                document.getElementById('enhancement-success-dialogue').textContent = characterData.enhancementSuccessDialogue || "ìµœê³ ì˜ ê²½ì§€ì— ë„ë‹¬í–ˆë‹¤!";
                enhancementSuccessModal.classList.remove('hidden');
            }

            updateUI();
            showCardDetails(cardId); // UI ê°±ì‹ 
            saveGame();
        }

            // --- í•µì‹¬ ê²Œì„ ë¡œì§ í•¨ìˆ˜ ---
            function switchTab(tabName) {
                if (isCombatRunning) return;
                allViews.forEach(view => view.classList.add('hidden'));
                allTabs.forEach(tab => tab.classList.remove('active'));
                document.getElementById(`${tabName}-view`).classList.remove('hidden');
                document.getElementById(`tab-${tabName}`).classList.add('active');
                if (tabName === 'home') displayHomeView();
                else if (tabName === 'inventory') displayInventory(); 
                else if (tabName === 'deck') displayDeckManagement();
                else if (tabName === 'combat') displayCombatView();
                else if (tabName === 'collection') displayCollection();
                else if (tabName === 'story') displayStoryView();
                else if (tabName === 'event') displayEventView();
                else if (tabName === 'achievements') displayAchievements();
            }
            
            function switchSubTab(viewContainer, button) {
                Array.from(viewContainer.children).forEach(view => {
                    if(view.id.endsWith('-view')) view.classList.add('hidden');
                });
                Array.from(button.parentElement.children).forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const viewId = button.id.replace('sub-tab-', '') + '-view';
                const viewElement = document.getElementById(viewId);
                if (viewElement) {
                    viewElement.classList.remove('hidden');
                }
            }

            function switchGachaTab(tabName) {
                if (tabName === 'normal') {
                    normalGachaView.classList.remove('hidden');
                    eventGachaView.classList.add('hidden');
                    gachaTabNormal.classList.add('active');
                    gachaTabEvent.classList.remove('active');
                } else {
                    normalGachaView.classList.add('hidden');
                    eventGachaView.classList.remove('hidden');
                    gachaTabNormal.classList.remove('active');
                    gachaTabEvent.classList.add('active');
                }
            }

            function checkEventStatus() {
                const now = new Date();
                const isEventActive = true; // For testing: now >= EVENT_START_DATE && now <= EVENT_END_DATE;
                if (isEventActive) {
                    eventBanner.classList.remove('hidden');
                    eventBannerText.textContent = `${EVENT_CHARACTER_NAME} í™•ë¥  UP!`;
                    eventGachaInfo.querySelector('p').textContent = `[${EVENT_CHARACTER_NAME}] ë“±ì¥ í™•ë¥  UP!`;
                    gachaTabEvent.classList.remove('hidden');
                    eventTab.classList.remove('hidden');
                    eventPointDisplay.classList.remove('hidden');
                } else {
                    eventBanner.classList.add('hidden');
                    gachaTabEvent.classList.add('hidden');
                    eventTab.classList.add('hidden');
                    eventPointDisplay.classList.add('hidden');
                    if(gachaTabEvent.classList.contains('active')) {
                        switchGachaTab('normal');
                    }
                }
            }

            function displayHomeView(cycleDialogue = false) {
                if (representativeCharacter) {
                    homeCharacterContainer.classList.remove('hidden');
                    homeDialogueContainer.classList.remove('hidden');
                    homeDefaultMessage.classList.add('hidden');
                    homeCharacterImage.src = representativeCharacter.imageUrl;
                    homeCharacterName.textContent = representativeCharacter.name;
                    if (cycleDialogue) {
                        const currentDialogue = homeCharacterDialogue.textContent;
                        let newDialogue;
                        do {
                            newDialogue = representativeCharacter.dialogues[Math.floor(Math.random() * representativeCharacter.dialogues.length)];
                        } while (representativeCharacter.dialogues.length > 1 && newDialogue === currentDialogue);
                        homeCharacterDialogue.textContent = newDialogue;
                    } else {
                         homeCharacterDialogue.textContent = representativeCharacter.dialogues[0];
                    }
                } else {
                    homeCharacterContainer.classList.add('hidden');
                    homeDialogueContainer.classList.add('hidden');
                    homeDefaultMessage.classList.remove('hidden');
                }
            }
            
            function displayEventView() {
                displayEventBattleView();
                displayEventStoryView();
                displayEventShopView();
                switchSubTab(document.getElementById('event-view'), eventSubTabBattle);
            }

            function displayEventBattleView() {
                eventDungeonListContainer.innerHTML = '';
                eventDungeons.forEach((dungeon, index) => {
                    const isUnlocked = index === 0 || clearedEventDungeons.includes(eventDungeons[index - 1].name);
                    const isCleared = clearedEventDungeons.includes(dungeon.name);
                    const dungeonEl = document.createElement('button');
                    dungeonEl.className = `p-4 rounded-lg transition-colors duration-300 text-center ${isUnlocked ? 'bg-white/20 hover:bg-white/30 cursor-pointer' : 'bg-black/30 text-gray-500 cursor-not-allowed'}`;
                    dungeonEl.disabled = !isUnlocked;
                    
                    dungeonEl.innerHTML = `
                        <h3 class="text-xl font-bold ${isUnlocked ? 'text-yellow-300' : ''}">${dungeon.name}</h3>
                        <p class="text-sm">ë³´ìƒ: ${dungeon.eventPointReward} P ${isCleared ? '<span class="text-green-400">(í´ë¦¬ì–´)</span>' : ''}</p>
                    `;
                    if(isUnlocked){
                        dungeonEl.onclick = () => challengeDungeon(index, 'event');
                    }
                    eventDungeonListContainer.appendChild(dungeonEl);
                });
            }

            function displayEventStoryView() {
                eventStoryContainer.innerHTML = '';
                eventStories.forEach((story, index) => {
                    const isUnlocked = index === 0 || clearedEventDungeons.includes(eventDungeons[index - 1].name);
                    const storyEl = document.createElement('div');
                    storyEl.className = `p-4 rounded-lg transition-colors duration-300 ${isUnlocked ? 'bg-white/20 hover:bg-white/30 cursor-pointer' : 'bg-black/30 text-gray-500'}`;
                    if (isUnlocked) {
                        storyEl.dataset.storyIndex = index;
                        storyEl.dataset.storyType = 'event';
                    }

                    storyEl.innerHTML = `
                        <h3 class="text-xl font-bold ${isUnlocked ? 'text-yellow-300' : ''}">${story.title}</h3>
                        <p class="text-sm">${isUnlocked ? 'í´ë¦­í•˜ì—¬ ìŠ¤í† ë¦¬ ì½ê¸°' : `${eventDungeons[index-1].name} í´ë¦¬ì–´ ì‹œ í•´ê¸ˆ`}</p>
                    `;
                    eventStoryContainer.appendChild(storyEl);
                });
            }
            
            function displayEventShopView() {
                eventPointsSpan.textContent = playerEventPoints;
                eventShopContainer.innerHTML = '';
                eventShopItems.forEach(item => {
                    const purchasedCount = purchasedEventItems[item.id] || 0;
                    const isSoldOut = purchasedCount >= item.limit;
                    const canAfford = playerEventPoints >= item.cost;

                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-black/20 p-4 rounded-lg flex justify-between items-center';
                    itemEl.innerHTML = `
                        <div>
                            <h3 class="text-lg font-bold text-yellow-300">${item.name}</h3>
                            <p class="text-sm text-gray-300">ê°€ê²©: ${item.cost} P</p>
                            <p class="text-xs text-gray-400">ë‚¨ì€ íšŸìˆ˜: ${item.limit - purchasedCount} / ${item.limit}</p>
                        </div>
                        <button data-item-id="${item.id}" class="gacha-button bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-full" ${isSoldOut || !canAfford ? 'disabled' : ''}>
                            ${isSoldOut ? 'í’ˆì ˆ' : 'êµ¬ë§¤'}
                        </button>
                    `;
                    eventShopContainer.appendChild(itemEl);
                });
            }
            
            function purchaseEventItem(itemId) {
                const item = eventShopItems.find(i => i.id === itemId);
                if (!item) return;

                const purchasedCount = purchasedEventItems[item.id] || 0;
                if (purchasedCount >= item.limit) {
                    showMessage('ì´ë¯¸ ìµœëŒ€ ìˆ˜ëŸ‰ì„ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤.', 'text-red-400', messageArea);
                    return;
                }
                if (playerEventPoints < item.cost) {
                    showMessage('ì´ë²¤íŠ¸ í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'text-red-400', messageArea);
                    return;
                }

                playerEventPoints -= item.cost;
                purchasedEventItems[item.id] = purchasedCount + 1;

                if (item.type === 'card') {
                    playerInventory.push(item.itemData);
                    showMessage(`[${item.name}] íšë“!`, 'text-green-300', messageArea);
                } else if (item.type === 'currency') {
                    playerCurrency += item.itemData;
                    showMessage(`ë³´ì„ ${item.itemData}ê°œ íšë“!`, 'text-green-300', messageArea);
                }

                updateUI();
                displayEventShopView();
                saveGame();
            }

            function calculateOfflineRegen() {
                if (playerBookmarks >= MAX_BOOKMARKS) {
                    lastBookmarkUpdateTime = Date.now();
                    return;
                }
                const now = Date.now();
                const timeDiff = now - lastBookmarkUpdateTime;
                const bookmarksToRegen = Math.floor(timeDiff / BOOKMARK_REGEN_TIME);

                if (bookmarksToRegen > 0) {
                    playerBookmarks = Math.min(MAX_BOOKMARKS, playerBookmarks + bookmarksToRegen);
                    lastBookmarkUpdateTime = lastBookmarkUpdateTime + bookmarksToRegen * BOOKMARK_REGEN_TIME;
                    saveGame();
                }
            }

            function startBookmarkRegenTimer() {
                setInterval(() => {
                    // ì´ ë¸”ë¡ì€ ì±…ê°ˆí”¼ê°€ ì‹¤ì œë¡œ ì¶©ì „ë˜ëŠ” ë¡œì§ì…ë‹ˆë‹¤.
                    if (playerBookmarks < MAX_BOOKMARKS) {
                        const now = Date.now();
                        if (now - lastBookmarkUpdateTime >= BOOKMARK_REGEN_TIME) {
                            playerBookmarks++;
                            lastBookmarkUpdateTime = now; // íƒ€ì´ë¨¸ë¥¼ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
                            updateUI();
                            saveGame();
                        }
                    }

                    // ì´ ë¸”ë¡ì€ ë‚¨ì€ ì‹œê°„ì„ í™”ë©´ì— í‘œì‹œí•˜ëŠ” ë¡œì§ì…ë‹ˆë‹¤.
                    if (playerBookmarks < MAX_BOOKMARKS) {
                        const timeRemaining = BOOKMARK_REGEN_TIME - (Date.now() - lastBookmarkUpdateTime);
                        const minutes = Math.floor(timeRemaining / 60000);
                        const seconds = Math.floor((timeRemaining % 60000) / 1000);
                        
                        // MM:SS í˜•ì‹ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤. (ì˜ˆ: 04:32)
                        bookmarkTimerContainer.textContent = `(${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')})`;
                        bookmarkTimerContainer.classList.remove('hidden');
                    } else {
                        // ì±…ê°ˆí”¼ê°€ ê°€ë“ ì°¨ë©´ íƒ€ì´ë¨¸ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
                        bookmarkTimerContainer.classList.add('hidden');
                    }
                }, 1000); // 1ì´ˆë§ˆë‹¤ ë°˜ë³µ
            }


            function setRepresentative(cardName) {
                const cardData = findCharacter(cardName);
                if (cardData) {
                    representativeCharacter = cardData;
                    showMessage(`${cardData.name}(ì„)ë¥¼ ëŒ€í‘œë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤!`, 'text-blue-300', messageArea);
                    displayInventory();
                    saveGame();
                }
            }
            
            function handlePull(count, cost, gachaType = 'normal') {
                if (playerInventory.length + count > inventoryCapacity) {
                    showMessage('ë³´ê´€í•¨ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!', 'text-yellow-400', messageArea); return;
                }
                if (playerCurrency >= cost) {
                    playerCurrency -= cost;
                    showMessage(`-ğŸ’${cost}`, 'text-red-400', messageArea);
                    performPulls(count, gachaType);
                } else {
                    showMessage('ì¬í™”ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!', 'text-red-400', messageArea);
                }
            }
            
            function expandInventory() {
                if (playerCurrency >= EXPAND_COST) {
                    playerCurrency -= EXPAND_COST; inventoryCapacity += EXPAND_AMOUNT;
                    showMessage(`ë³´ê´€í•¨ì´ ${inventoryCapacity}ì¹¸ìœ¼ë¡œ í™•ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'text-green-300', messageArea);
                    updateUI(); displayInventory(); saveGame();
                    checkAchievements();
                } else {
                    showMessage('ë³´ì„ì´ ë¶€ì¡±í•˜ì—¬ í™•ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'text-red-400', messageArea);
                }
            }

            function updateUI() {
                currencyDisplay.textContent = playerCurrency;
                eventPointsSpan.textContent = playerEventPoints;
                bookmarkDisplay.textContent = playerBookmarks;
                maxBookmarkDisplay.textContent = MAX_BOOKMARKS;

                const buttons = [pullOneButton, pullTenButton, pullOneEventButton, pullTenEventButton];
                buttons.forEach(btn => {
                    if (btn.id.includes('ten')) btn.disabled = playerCurrency < PULL_TEN_COST;
                    else btn.disabled = playerCurrency < PULL_ONE_COST;
                });
                expandInventoryButton.disabled = playerCurrency < EXPAND_COST;
            }

            function showMessage(message, colorClass, element) {
                element.textContent = message;
                element.className = `text-center text-lg h-8 mb-4 transition-opacity duration-300 ${colorClass}`;
                setTimeout(() => { element.textContent = ''; }, 2000);
            }

            function performPulls(count, gachaType = 'normal') {
                const results = [];
                let guaranteedSR = (count === 10);
                for (let i = 0; i < count; i++) {
                    let pulledChar;
                    if (guaranteedSR && i === count - 1 && !results.some(c => c.rarity === 'SR' || c.rarity === 'SSR')) {
                        pulledChar = pullCharacter(['SR', 'SSR'], gachaType);
                    } else {
                        pulledChar = pullCharacter(null, gachaType);
                    }
                    results.push(pulledChar);
                    playerInventory.push({ 
						id: Date.now() + Math.random(), // ê° ì¹´ë“œì— ê³ ìœ  ID ë¶€ì—¬
						name: pulledChar.name, 
						enhancementLevel: 0 
					});
                    playerStats.totalPulls++; // ì´ ì¤„ ì¶”ê°€
                }
                displayResults(results); updateUI(); saveGame();
                checkAchievements(); // ì´ ì¤„ ì¶”ê°€
            }

            function pullCharacter(allowedRarities = null, gachaType = 'normal') {
                const now = new Date();
                const isEventActive = true; // For testing
                const useEventRates = gachaType === 'event' && isEventActive;
                const probabilities = useEventRates ? eventRarityProbabilities : rarityProbabilities;
                
                let selectedRarity = '';
                if (allowedRarities) {
                    const highTierProb = { 'SSR': probabilities['SSR'], 'SR': probabilities['SR'] };
                    const totalProb = highTierProb.SSR + highTierProb.SR;
                    selectedRarity = (Math.random() * totalProb < highTierProb.SSR) ? 'SSR' : 'SR';
                } else {
                    const rand = Math.random() * 100; let cumulativeProb = 0;
                    for (const rarity in probabilities) {
                        cumulativeProb += probabilities[rarity];
                        if (rand < cumulativeProb) { selectedRarity = rarity; break; }
                    }
                }

                if (useEventRates && (selectedRarity === 'SSR' || selectedRarity === 'SR')) {
                    if (Math.random() < 0.5) { // 50% chance for event character
                        return characters.find(c => c.name === EVENT_CHARACTER_NAME);
                    } else {
                        const otherChars = characters.filter(c => c.rarity === selectedRarity && c.name !== EVENT_CHARACTER_NAME);
                        if (otherChars.length > 0) return otherChars[Math.floor(Math.random() * otherChars.length)];
                        return characters.find(c => c.name === EVENT_CHARACTER_NAME); // Fallback
                    }
                }

                const possibleCharacters = characters.filter(char => char.rarity === selectedRarity);
                return possibleCharacters[Math.floor(Math.random() * possibleCharacters.length)];
            }

            function displayResults(pulledCharacters) {
                resultsContainer.innerHTML = '';
                pulledCharacters.forEach((character, index) => {
                    resultsContainer.appendChild(createCard(character, { animationIndex: index, mode: 'gachaResult' }));
                });
            }
            
           

            

            function displayInventory() {
        inventoryStatus.textContent = `${playerInventory.length} / ${inventoryCapacity}`;
        inventoryContainer.innerHTML = '';

        // ê°•í™” ë ˆë²¨ê³¼ ë“±ê¸‰ ìˆœìœ¼ë¡œ ì •ë ¬
        const sortedInventory = [...playerInventory].sort((a, b) => {
            const charA = findCharacter(a.name);
            const charB = findCharacter(b.name);
            const rarityOrder = { 'SSR': 4, 'SR': 3, 'R': 2, 'N': 1 };
            if (b.enhancementLevel !== a.enhancementLevel) return b.enhancementLevel - a.enhancementLevel;
            if (rarityOrder[charB.rarity] !== rarityOrder[charA.rarity]) return rarityOrder[charB.rarity] - rarityOrder[charA.rarity];
            return a.name.localeCompare(b.name);
        });

        if (sortedInventory.length === 0) {
            inventoryContainer.innerHTML = `<p class="col-span-full text-center text-gray-400 mt-10">ì•„ì§ ìˆ˜ì§‘í•œ ë™ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>`; return;
        }
        sortedInventory.forEach((cardInstance, index) => {
            inventoryContainer.appendChild(createCard(cardInstance, { animationIndex: index, mode: 'inventory' }));
        });
    }


            function displayDeckManagement() {
    deckStatus.textContent = `í˜„ì¬ ë±: ${playerDeck.length} / ${DECK_CAPACITY}`;
    deckStatus.classList.toggle('text-green-400', playerDeck.length === DECK_CAPACITY);
    deckSlotsContainer.innerHTML = '';

    for (let i = 0; i < DECK_CAPACITY; i++) {
        if (playerDeck[i]) {
            const characterData = findCharacter(playerDeck[i].name);
            const cardDataForDisplay = { ...characterData, ...playerDeck[i] }; // ê¸°ë³¸ ì •ë³´ + ì¸ìŠ¤í„´ìŠ¤ ì •ë³´
            deckSlotsContainer.appendChild(createCard(cardDataForDisplay, { mode: 'deckSlot' }));
        } else {
            const emptySlot = document.createElement('div');
            emptySlot.className = 'deck-slot rounded-lg'; emptySlot.textContent = 'ë¹„ì–´ìˆìŒ';
            deckSlotsContainer.appendChild(emptySlot);
        }
    }

    deckInventoryContainer.innerHTML = '';
    const sortedInventory = [...playerInventory].sort((a, b) => { /* ì •ë ¬ ë¡œì§ì€ displayInventoryì™€ ë™ì¼ */
        const charA = findCharacter(a.name); const charB = findCharacter(b.name);
        const rarityOrder = { 'SSR': 4, 'SR': 3, 'R': 2, 'N': 1 };
        if (b.enhancementLevel !== a.enhancementLevel) return b.enhancementLevel - a.enhancementLevel;
        if (rarityOrder[charB.rarity] !== rarityOrder[charA.rarity]) return rarityOrder[charB.rarity] - rarityOrder[charA.rarity];
        return a.name.localeCompare(b.name);
    });

    if (sortedInventory.length === 0) {
        deckInventoryContainer.innerHTML = `<p class="col-span-full text-center text-gray-400 mt-10">ë±ì— ì¶”ê°€í•  ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>`; return;
    }

    sortedInventory.forEach((cardInstance, index) => {
        const characterData = findCharacter(cardInstance.name);
        const cardDataForDisplay = { ...characterData, ...cardInstance };
        const isCardInDeck = playerDeck.some(deckCard => deckCard.id === cardInstance.id);
        const isDeckFull = playerDeck.length >= DECK_CAPACITY;
        deckInventoryContainer.appendChild(createCard(cardDataForDisplay, { animationIndex: index, mode: 'deckBuilder', isCardInDeck, isDeckFull }));
    });
    displaySynergies();
}
            
            function autoFillDeck() {
    const sortedByPower = [...playerInventory].sort((a, b) => {
        const charA = findCharacter(a.name);
        const charB = findCharacter(b.name);
        const powerA = charA.stats.atk + charA.stats.def + (a.enhancementLevel * 5); // ê°•í™” ë³´ë„ˆìŠ¤ ê°€ì¤‘ì¹˜
        const powerB = charB.stats.atk + charB.stats.def + (b.enhancementLevel * 5);
        return powerB - powerA;
    });
    playerDeck = sortedByPower.slice(0, DECK_CAPACITY);
    displayDeckManagement();
    showMessage('ê°€ì¥ ê°•ë ¥í•œ ì¹´ë“œë¡œ ë±ì„ ìë™ í¸ì„±í–ˆìŠµë‹ˆë‹¤!', 'text-blue-300', messageArea);
    saveGame();
}

            function addToDeck(cardId) {
    const cardIdNum = parseFloat(cardId);
    if (playerDeck.length >= DECK_CAPACITY || playerDeck.some(card => card.id === cardIdNum)) return;
    const cardToAdd = playerInventory.find(card => card.id === cardIdNum);
    if (cardToAdd) { playerDeck.push(cardToAdd); displayDeckManagement(); saveGame(); }
}

function removeFromDeck(cardId) {
    const cardIdNum = parseFloat(cardId);
    const indexToRemove = playerDeck.findIndex(card => card.id === cardIdNum);
    if(indexToRemove > -1) {
        playerDeck.splice(indexToRemove, 1);
    }
    displayDeckManagement();
    saveGame();
}
            
				// ìœ„ì¹˜: gacha1.html, ì•½ 1129ë²ˆì§¸ ì¤„
			function calculateDeckPower() {
				if (playerDeck.length === 0) return 0;
				const deckWithBonuses = applySynergyBonusesToDeck(playerDeck);
				return deckWithBonuses.reduce((total, card) => total + (card.stats.atk + card.stats.def + Math.floor(card.stats.hp / 10)), 0);
			}

            function displayCombatView() {
            deckPowerDisplay.textContent = calculateDeckPower();
            dungeonVolumeSelection.innerHTML = '';
            dungeonStageSelection.classList.add('hidden');
            dungeonVolumeSelection.classList.remove('hidden');

            dungeons.forEach((volume, index) => {
                const volumeEl = document.createElement('div');
                volumeEl.className = 'bg-black/20 p-6 rounded-lg text-center cursor-pointer hover:bg-black/30';
                volumeEl.innerHTML = `<h3 class="text-2xl font-bold text-yellow-300">${volume.name}</h3>`;
                volumeEl.onclick = () => displayDungeonStages(index);
                dungeonVolumeSelection.appendChild(volumeEl);
            });
        }

        function displayDungeonStages(volumeIndex) {
            const volume = dungeons[volumeIndex];
            dungeonVolumeSelection.classList.add('hidden');
            dungeonStageSelection.classList.remove('hidden');
            currentVolumeTitle.textContent = volume.name;
            stageListContainer.innerHTML = '';

            volume.stages.forEach((stage, stageIndex) => {
                const isCleared = clearedStages[volume.name]?.includes(stageIndex);
                const stageEl = document.createElement('button');
                stageEl.className = 'p-4 rounded-lg transition-colors duration-300 text-center bg-white/20 hover:bg-white/30';
                stageEl.innerHTML = `
                    <h4 class="text-lg font-bold">${stage.name}</h4>
                    <p class="text-sm">ë³´ìƒ: ğŸ–Šï¸ ${stage.reward.pens} ${isCleared ? '<span class="text-green-400">(í´ë¦¬ì–´)</span>' : ''}</p>
                `;
                stageEl.onclick = () => challengeDungeon(volumeIndex, stageIndex, 'main');
                stageListContainer.appendChild(stageEl);
            });
        }
            
            function challengeDungeon(dungeonIndex, type = 'main') {
                if (playerBookmarks < 1) {
                    const msgArea = type === 'event' ? document.getElementById('message-area') : (document.getElementById('combat-message-area') || messageArea);
                    showMessage('ì±…ê°ˆí”¼ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!', 'text-yellow-400', msgArea);
                    return;
                }
                if (playerDeck.length < DECK_CAPACITY) {
                    const msgArea = type === 'event' ? document.getElementById('message-area') : (document.getElementById('combat-message-area') || messageArea);
                    showMessage('ë±ì„ 5ì¥ìœ¼ë¡œ ëª¨ë‘ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤!', 'text-yellow-400', msgArea);
                    return;
                }
                
                playerBookmarks--;
                if (playerBookmarks === MAX_BOOKMARKS - 1) {
                     lastBookmarkUpdateTime = Date.now();
                }
                updateUI();
                // saveGame(); // ì „íˆ¬ ì‹œì‘ ì „ì— ì €ì¥í•˜ì§€ ì•Šê³ , ì „íˆ¬ ì¢…ë£Œ í›„ì— ì €ì¥.

                startCombat(dungeonIndex, type);
            }

            function setCombatSpeed(speed) {
                combatSpeedMultiplier = speed;
                const allSpeedButtons = document.querySelectorAll('.speed-button');
                allSpeedButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.add('bg-gray-600');
                    btn.classList.remove('bg-blue-500');
                });
                document.getElementById(`speed-${speed}x`).classList.add('active', 'bg-blue-500');
                document.getElementById(`speed-${speed}x`).classList.remove('bg-gray-600');
            }

            async function startCombat(dungeonIndex, type) {
                isCombatRunning = true;
                setCombatSpeed(1); // ì „íˆ¬ ì‹œì‘ ì‹œ 1ë°°ì†ìœ¼ë¡œ ì´ˆê¸°í™”
                const dungeonList = type === 'event' ? eventDungeons : dungeons;
                const dungeon = dungeonList[dungeonIndex];
                const monsterData = JSON.parse(JSON.stringify(monsters[dungeon.monsterName]));
                const combatDeck = applySynergyBonusesToDeck(playerDeck); // ë³´ë„ˆìŠ¤ê°€ ì ìš©ëœ ë±
				const originalBonusDeck = JSON.parse(JSON.stringify(combatDeck)); // ë³´ë„ˆìŠ¤ ì ìš©ëœ ë±ì˜ ì›ë³¸ (ìµœëŒ€ HP ê³„ì‚°ìš©)

                allViews.forEach(view => view.classList.add('hidden'));
                combatInProgressView.classList.remove('hidden');
                combatLog.innerHTML = '';
                combatPlayerDeck.innerHTML = '';
                combatDeck.forEach((card, index) => {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'bg-gray-700 p-2 rounded';
                    cardEl.innerHTML = `
                        <p class="font-bold text-sm truncate" title="${card.name}">${card.name}</p>
                        <div class="hp-bar-background rounded-full h-2.5 mt-1">
                            <div id="player-hp-bar-${index}" class="hp-bar-foreground h-2.5 rounded-full" style="width: 100%"></div>
                        </div>
                        <p id="player-hp-text-${index}" class="text-xs text-center mt-0.5">${card.stats.hp} / ${card.stats.hp}</p>
                    `;
                    combatPlayerDeck.appendChild(cardEl);
                });

                combatMonsterArea.innerHTML = `
                    <h3 class="text-2xl font-bold">${monsterData.name}</h3>
                    <img id="combat-monster-image" src="${monsterData.imageUrl}" alt="${monsterData.name}" class="my-4 h-48 w-48 object-contain">
                    <div class="w-full hp-bar-background rounded-full h-4">
                        <div id="monster-hp-bar" class="hp-bar-foreground h-4 rounded-full" style="width: 100%"></div>
                    </div>
                    <p id="monster-hp-text" class="text-sm mt-1">${monsterData.stats.hp} / ${monsterData.stats.hp}</p>
                `;
                
                await runCombatLoop(combatDeck, originalBonusDeck, monsterData, dungeon, type);
            }

            const delay = ms => new Promise(res => setTimeout(res, ms / combatSpeedMultiplier));

            async function runCombatLoop(combatDeck, originalBonusDeck, monsterData, dungeon, type) { // originalBonusDeck ì¸ì ì¶”ê°€
				const originalMonsterDef = monsterData.stats.def;

				while (monsterData.stats.hp > 0 && combatDeck.some(c => c.stats.hp > 0)) {
					for (let i = 0; i < combatDeck.length; i++) {
						const card = combatDeck[i];
						if (card.stats.hp > 0) {
                            await delay(800);
                            const monsterImage = document.getElementById('combat-monster-image');
                            
                            const useUltimate = card.rarity === 'SSR' && Math.random() < 0.25;
                            const useSkill = Math.random() < 0.4;
                            let skillToUse = null;

                            if (useUltimate && card.skills.length > 1) skillToUse = card.skills[1];
                            else if (useSkill) skillToUse = card.skills[0];

                            let damage = 0;
                            if (skillToUse) {
                                logCombat(`<strong>${card.name}</strong>ì˜ ìŠ¤í‚¬! <span class="text-yellow-300">"${skillToUse.name}"</span>`);
                                await delay(400);
                                logCombat(`<em>"${skillToUse.dialogue}"</em>`);
                                
                                damage = Math.max(1, Math.floor(card.stats.atk * skillToUse.power) - monsterData.stats.def);
                                
                                if (skillToUse.type === 'vampire') {
                                    const healedAmount = Math.floor(damage * 0.5);
                                    const maxHpForThisCard = originalBonusDeck[i].stats.hp; // ì „íˆ¬ ì‹œì‘ ì‹œì ì˜ ìµœëŒ€ HP
									card.stats.hp = Math.min(maxHpForThisCard, card.stats.hp + healedAmount);
									logCombat(`<strong>${card.name}</strong>ì´(ê°€) ${healedAmount}ì˜ ì²´ë ¥ì„ íšŒë³µí–ˆë‹¤!`);
                                }
                                if (skillToUse.type === 'debuff_def') {
                                    monsterData.stats.def = Math.max(0, Math.floor(monsterData.stats.def * 0.8));
                                    logCombat(`<strong>${monsterData.name}</strong>ì˜ ë°©ì–´ë ¥ì´ ê°ì†Œí–ˆë‹¤!`);
                                }

                            } else {
                                logCombat(`<strong>${card.name}</strong>ì˜ ì¼ë°˜ ê³µê²©!`);
                                damage = Math.max(1, card.stats.atk - monsterData.stats.def);
                            }
                            
                            monsterData.stats.hp = Math.max(0, monsterData.stats.hp - damage);
                            logCombat(`<strong>${monsterData.name}</strong>ì—ê²Œ ${damage}ì˜ ë°ë¯¸ì§€!`);
                            monsterImage.classList.add('shake-animation');
                            updateCombatUI(combatDeck, originalBonusDeck, monsterData);
                            setTimeout(() => monsterImage.classList.remove('shake-animation'), 300 / combatSpeedMultiplier);

                            if (monsterData.stats.hp <= 0) break;
                        }
                    }
                    if (monsterData.stats.hp <= 0) break;

                    await delay(1000);
                    const alivePlayers = combatDeck.filter(c => c.stats.hp > 0);
                    if (alivePlayers.length > 0) {
                        const targetCard = alivePlayers[Math.floor(Math.random() * alivePlayers.length)];
                        logCombat(`<strong>${monsterData.name}</strong>ì˜ ê³µê²©!`);
                        const damage = Math.max(1, monsterData.stats.atk - targetCard.stats.def);
                        const hpBeforeAttack = targetCard.stats.hp;
                        targetCard.stats.hp = Math.max(0, targetCard.stats.hp - damage);
                        logCombat(`<strong>${targetCard.name}</strong>ì—ê²Œ ${damage}ì˜ ë°ë¯¸ì§€!`);
                        
                        if (targetCard.stats.hp <= 0 && hpBeforeAttack > 0) {
                            await delay(400);
                            logCombat(`<strong>${targetCard.name}</strong>: <em>"${targetCard.deathDialogue}"</em>`);
                        }

                        updateCombatUI(combatDeck, originalBonusDeck, monsterData);
                    }
                }
                
                await delay(1000);
                monsterData.stats.def = originalMonsterDef;
                endCombat(monsterData.stats.hp <= 0, dungeon, type);
            }

            function logCombat(message) {
                combatLog.innerHTML += `<p>${message}</p>`;
                combatLogContainer.scrollTop = combatLogContainer.scrollHeight;
            }

             function updateCombatUI(deck, originalBonusDeck, monster) {
				deck.forEach((card, index) => {
					const originalCardWithBonus = originalBonusDeck[index];
					if(!originalCardWithBonus) return;

					const maxHp = originalCardWithBonus.stats.hp; // ì „íˆ¬ ì‹œì‘ ì‹œì ì˜ ìµœëŒ€ HP
					const currentHp = card.stats.hp;

					const hpPercent = maxHp > 0 ? (currentHp / maxHp) * 100 : 0;
					document.getElementById(`player-hp-bar-${index}`).style.width = `${hpPercent}%`;
					document.getElementById(`player-hp-text-${index}`).textContent = `${currentHp} / ${maxHp}`;
				});

				const monsterMaxHp = monsters[monster.name].stats.hp;
				const monsterHpPercent = (monster.stats.hp / monsterMaxHp) * 100;
				document.getElementById('monster-hp-bar').style.width = `${monsterHpPercent}%`;
				document.getElementById('monster-hp-text').textContent = `${monster.stats.hp} / ${monsterMaxHp}`;
			}
			
            function endCombat(isVictory, dungeon, type) {
                lastCombatType = type; // í˜„ì¬ ì¢…ë£Œëœ ì „íˆ¬ ìœ í˜•ì„ ì €ì¥í•©ë‹ˆë‹¤.
                if (isVictory) {
                    let rewardMsg = '';
                    if(type === 'event') {
                        const reward = dungeon.eventPointReward;
                        playerEventPoints += reward;
                        if (!clearedEventDungeons.includes(dungeon.name)) {
                            clearedEventDungeons.push(dungeon.name);
                        }
                        rewardMsg = `ì´ë²¤íŠ¸ ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´! ${reward} Pë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`;
                    } else {
                        if (!clearedDungeons.includes(dungeon.name)) {
                            clearedDungeons.push(dungeon.name);
                        }
                        const earnedReward = dungeon.rewards.min + Math.floor(Math.random() * (dungeon.rewards.max - dungeon.rewards.min + 1));
                        playerCurrency += earnedReward;
						const penReward = dungeon.reward.pens || 0;
						playerPens += penReward;
						rewardMsg += ` ğŸ–Šï¸${penReward}ë„ íšë“í–ˆìŠµë‹ˆë‹¤.`;

						if (!clearedStages[volumeName]) {
						clearedStages[volumeName] = [];
						}
						if (!clearedStages[volumeName].includes(stageIndex)) {
						clearedStages[volumeName].push(stageIndex);
						}
                        rewardMsg = `ë˜ì „ í´ë¦¬ì–´! ğŸ’${earnedReward}ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`;
                    }
                    combatResultTitle.textContent = "ìŠ¹ë¦¬!";
                    combatResultTitle.className = "text-4xl font-bold mb-4 text-green-400";
                    combatResultMessage.textContent = rewardMsg;
                } else {
                    combatResultTitle.textContent = "íŒ¨ë°°...";
                    combatResultTitle.className = "text-4xl font-bold mb-4 text-red-400";
                    combatResultMessage.textContent = `ì „íˆ¬ì—ì„œ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...`;
                }
                
                updateUI();
                saveGame();
                checkAchievements();
                combatResultModal.classList.remove('hidden');
                isCombatRunning = false;
            }

            function createCard(character, options = {}) {
                const { animationIndex, mode = 'default', isCardInDeck, isDeckFull, isCollected } = options;
                const card = document.createElement('div');
                card.className = `rarity-${character.rarity} relative text-center rounded-lg shadow-md p-2 transform transition-transform duration-300 hover:scale-105 cursor-pointer`;
                card.dataset.cardId = character.id; // ê³ ìœ  IDë¡œ ë³€ê²½
				card.dataset.cardName = character.name;
                card.title = character.name;
                const rarityColor = { 'N': 'text-gray-600', 'R': 'text-blue-800', 'SR': 'text-white', 'SSR': 'text-black' }[character.rarity];
                const factionColors = {
                    'íƒì •': 'bg-blue-500 text-white',
                    'ì¡°ìˆ˜': 'bg-green-500 text-white',
                    'ë²”ì¸': 'bg-red-500 text-white'
                };
                
                let badgeHTML = '';
                if(mode === 'inventory' && character.count > 1) {
                    badgeHTML = `<div class="count-badge">x${character.count}</div>`;
                }
				
				let enhancementHTML = '';
				if (character.enhancementLevel > 0) {
				enhancementHTML = `<div class="absolute top-1 left-1 bg-yellow-400 text-black font-bold text-xs px-2 py-0.5 rounded-full z-10">+${character.enhancementLevel}</div>`;
				}

                let actionButtonsHTML = '';
                if (mode === 'deckBuilder') {
                    const disabled = isDeckFull || isCardInDeck;
                    const buttonText = isCardInDeck ? 'ì¶”ê°€ë¨' : 'ì¶”ê°€';
                    const buttonColor = disabled ? 'bg-gray-500' : 'bg-green-500 hover:bg-green-600';
                    actionButtonsHTML = `<button data-action="add-to-deck" data-card-name="${character.name}" class="w-full mt-2 py-1 rounded-md text-white font-bold text-sm ${buttonColor}" ${disabled ? 'disabled' : ''}>${buttonText}</button>`;
                } else if (mode === 'inventory') {
                    const isRepresentative = representativeCharacter && representativeCharacter.name === character.name;
                    const repButtonText = isRepresentative ? 'ëŒ€í‘œ' : 'ëŒ€í‘œ ì„¤ì •';
                    const repButtonColor = isRepresentative ? 'bg-yellow-500' : 'bg-gray-600 hover:bg-gray-700';
                    actionButtonsHTML = `<button data-action="set-representative" data-card-name="${character.name}" class="w-full mt-2 py-1 rounded-md text-white font-bold text-sm ${repButtonColor}" ${isRepresentative ? 'disabled' : ''}>${repButtonText}</button>`;
                }
                
                let deckSlotButton = '';
                if(mode === 'deckSlot') {
                    deckSlotButton = `<button data-action="remove-from-deck" data-card-name="${character.name}" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 text-sm font-bold flex items-center justify-center z-10">X</button>`;
                }

                const factionBadge = `<span class="absolute top-2 right-2 text-xs font-bold px-2 py-1 rounded-full ${factionColors[character.faction]} z-10">${character.faction}</span>`;

                card.innerHTML = `
                    ${badgeHTML} ${deckSlotButton} ${factionBadge}
                    <div class="relative pointer-events-none">
                        <img src="${character.cardImageUrl}" alt="${character.name}" class="w-full h-auto rounded-md mb-2 border-2 border-white/50">
                        <p class="font-bold text-sm ${rarityColor} truncate">${character.name}</p>
                        <p class="font-black text-lg ${rarityColor}" style="text-shadow: 1px 1px 2px rgba(255,255,255,0.5);">${character.rarity}</p>
                    </div>
                     ${actionButtonsHTML}
                `;
                if (typeof animationIndex === 'number') {
                    card.style.opacity = '0';
                    card.style.animationDelay = `${animationIndex * 0.05}s`;
                    card.classList.add('card-animation');
                }
                if(mode === 'deckBuilder' && isCardInDeck) {
                    card.classList.add('opacity-50');
                }
                if (mode === 'collection') {
                    if (isCollected) {
                        card.dataset.isCollected = "true";
                    } else {
                        card.dataset.isCollected = "false";
                        card.classList.add('grayscale', 'opacity-75');
                        card.classList.remove('hover:scale-105', 'cursor-pointer');
                    }
                }
                return card;
            }

            function getSkillDescription(skill) {
                switch(skill.type) {
                    case 'damage': return `ê³µê²©ë ¥ì˜ ${skill.power * 100}% ë§Œí¼ í”¼í•´ë¥¼ ì¤ë‹ˆë‹¤.`;
                    case 'debuff_def': return `ì ì˜ ë°©ì–´ë ¥ì„ ì¼ì‹œì ìœ¼ë¡œ ê°ì†Œì‹œí‚µë‹ˆë‹¤.`;
                    case 'vampire': return `ê°€í•œ í”¼í•´ì˜ 50% ë§Œí¼ ì²´ë ¥ì„ íšŒë³µí•©ë‹ˆë‹¤.`;
                    default: return 'íŠ¹ë³„í•œ íš¨ê³¼ë¥¼ ê°€ì§„ ìŠ¤í‚¬ì…ë‹ˆë‹¤.';
                }
            }

            function showCardDetails(cardId) {
            const cardInstance = playerInventory.find(c => c.id === cardId);
            const character = findCharacter(cardInstance.name);
            if (!character) return;

                document.getElementById('detail-card-image').src = character.imageUrl;
                document.getElementById('detail-card-name').textContent = character.name;
                const rarityEl = document.getElementById('detail-card-rarity');
                rarityEl.textContent = character.rarity;
                const rarityColor = { 'N': 'text-gray-400', 'R': 'text-blue-400', 'SR': 'text-purple-400', 'SSR': 'text-yellow-400' }[character.rarity];
                rarityEl.className = `font-bold text-2xl ${rarityColor}`;

                const factionEl = document.getElementById('detail-card-faction');
                factionEl.textContent = character.faction;
                const factionColors = {
                    'íƒì •': 'bg-blue-500 text-white',
                    'ì¡°ìˆ˜': 'bg-green-500 text-white',
                    'ë²”ì¸': 'bg-red-500 text-white'
                };
                factionEl.className = `font-bold text-lg px-3 py-1 rounded-full ${factionColors[character.faction]}`;


                document.getElementById('detail-stat-hp').textContent = character.stats.hp;
                document.getElementById('detail-stat-atk').textContent = character.stats.atk;
                document.getElementById('detail-stat-def').textContent = character.stats.def;

				// ê°•í™” UI ì—…ë°ì´íŠ¸
            const enhancementUI = document.getElementById('enhancement-ui');
            const maxEnhancementText = document.getElementById('max-enhancement-text');
            if (cardInstance.enhancementLevel < 9) {
                enhancementUI.classList.remove('hidden');
                maxEnhancementText.classList.add('hidden');
                document.getElementById('detail-enhancement-level').textContent = `+${cardInstance.enhancementLevel}`;
                const cost = enhancementCosts[cardInstance.enhancementLevel];
                document.getElementById('detail-enhancement-cost').textContent = cost;
                const enhanceButton = document.getElementById('detail-enhancement-button');
                enhanceButton.disabled = playerPens < cost;
                enhanceButton.onclick = () => enhanceCard(cardId);
            } else {
                enhancementUI.classList.add('hidden');
                maxEnhancementText.classList.remove('hidden');
            }
				
                const skillsContainer = document.getElementById('detail-skills-container');
                skillsContainer.innerHTML = '';
                character.skills.forEach((skill, index) => {
                    const isUltimate = character.rarity === 'SSR' && index === 1;
                    const skillEl = document.createElement('div');
                    skillEl.className = 'bg-black/20 p-3 rounded-lg';
                    skillEl.innerHTML = `
                        <h4 class="font-bold ${isUltimate ? 'text-yellow-300' : 'text-white'}">${isUltimate ? 'ê¶ê·¹ê¸°' : 'ì¼ë°˜ ìŠ¤í‚¬'}: ${skill.name}</h4>
                        <p class="text-gray-300 italic">"${skill.dialogue}"</p>
                        <p class="text-sm mt-1">${getSkillDescription(skill)}</p>
                    `;
                    skillsContainer.appendChild(skillEl);
                });
                
                currentStoryPages = character.story.split('[PAGE_BREAK]');
                currentStoryPageIndex = 0;
                displayCardStoryPage();
                
                cardDetailModal.classList.remove('hidden');
            }
            
            function displayCardStoryPage() {
                const storyContent = document.getElementById('detail-card-story');
                const pageIndicator = document.getElementById('detail-story-page-indicator');
                
                storyContent.textContent = currentStoryPages[currentStoryPageIndex];
                pageIndicator.textContent = `${currentStoryPageIndex + 1} / ${currentStoryPages.length}`;
                
                detailStoryPrevButton.disabled = currentStoryPageIndex === 0;
                detailStoryNextButton.disabled = currentStoryPageIndex === currentStoryPages.length - 1;
            }

            function hideCardDetails() {
                cardDetailModal.classList.add('hidden');
            }
            
            function findCharacter(name) {
                return characters.find(c => c.name === name);
            }

            function displayStoryView() {
                mainStoryContainer.innerHTML = '';
                mainStories.forEach((story, index) => {
                    const isUnlocked = story.dungeonToUnlock === null || clearedDungeons.includes(story.dungeonToUnlock);
                    const storyEl = document.createElement('div');
                    storyEl.className = `p-4 rounded-lg transition-colors duration-300 ${isUnlocked ? 'bg-white/20 hover:bg-white/30 cursor-pointer' : 'bg-black/30 text-gray-500'}`;
                    if (isUnlocked) {
                        storyEl.dataset.storyIndex = index;
                        storyEl.dataset.storyType = 'main';
                    }

                    storyEl.innerHTML = `
                        <h3 class="text-xl font-bold ${isUnlocked ? 'text-yellow-300' : ''}">${story.title}</h3>
                        <p class="text-sm">${isUnlocked ? 'í´ë¦­í•˜ì—¬ ìŠ¤í† ë¦¬ ì½ê¸°' : `${story.dungeonToUnlock} í´ë¦¬ì–´ ì‹œ í•´ê¸ˆ`}</p>
                    `;
                    mainStoryContainer.appendChild(storyEl);
                });
            }
			
			// --- ëŒ€í™”í˜• ìŠ¤í† ë¦¬ ê´€ë ¨ í•¨ìˆ˜ (ìƒˆ ë²„ì „) ---
            function startInteractiveStory(storyIndex, type) {
                const storyList = type === 'main' ? mainStories : eventStories;
                currentInteractiveStory = storyList[storyIndex];
                if (!currentInteractiveStory || !Array.isArray(currentInteractiveStory.content)) return;

                currentSceneIndex = 0;
                interactiveStoryModal.classList.remove('hidden');
                renderCurrentScene();
            }

            function renderCurrentScene() {
                const scene = currentInteractiveStory.content[currentSceneIndex];
                if (!scene) {
                    closeInteractiveStory();
                    return;
                }

                // ëŒ€í™” ë‚´ìš© ë° í™”ì ì´ë¦„ ì—…ë°ì´íŠ¸
                speakerName.textContent = scene.character || ' '; // ìºë¦­í„°ê°€ nullì´ë©´ ë‚˜ë ˆì´ì…˜
                dialogueText.textContent = scene.dialogue;

                // ìºë¦­í„° ì´ë¯¸ì§€ ì²˜ë¦¬
                if (scene.character) {
                    const portraitUrl = characterPortraits[scene.character]?.[scene.expression] || '';
                    if (scene.position === 'left') {
                        storyCharLeft.src = portraitUrl;
                        storyCharLeft.classList.remove('opacity-0');
                        storyCharLeft.classList.add('opacity-100');
                        storyCharRight.classList.remove('opacity-100');
                        storyCharRight.classList.add('opacity-0');
                    } else if (scene.position === 'right') {
                        storyCharRight.src = portraitUrl;
                        storyCharRight.classList.remove('opacity-0');
                        storyCharRight.classList.add('opacity-100');
                        storyCharLeft.classList.remove('opacity-100');
                        storyCharLeft.classList.add('opacity-0');
                    }
                } else { // ë‚˜ë ˆì´ì…˜ì¼ ê²½ìš° ëª¨ë“  ìºë¦­í„° ìˆ¨ê¹€
                    storyCharLeft.classList.remove('opacity-100');
                    storyCharLeft.classList.add('opacity-0');
                    storyCharRight.classList.remove('opacity-100');
                    storyCharRight.classList.add('opacity-0');
                }
            }

            function advanceStory() {
                currentSceneIndex++;
                if (currentSceneIndex < currentInteractiveStory.content.length) {
                    renderCurrentScene();
                } else {
                    closeInteractiveStory();
                }
            }

            function closeInteractiveStory() {
                interactiveStoryModal.classList.add('hidden');
                storyCharLeft.src = ''; // ì´ë¯¸ì§€ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
                storyCharRight.src = '';
                currentInteractiveStory = null;
            }
            
            // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
            allTabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.id.split('-')[1])));
            achievementsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('[data-ach-id]');
                if (button) {
                    claimAchievement(button.dataset.achId);
                }
            });
            pullOneButton.addEventListener('click', () => handlePull(1, PULL_ONE_COST, 'normal'));
            pullTenButton.addEventListener('click', () => handlePull(10, PULL_TEN_COST, 'normal'));
            pullOneEventButton.addEventListener('click', () => handlePull(1, PULL_ONE_COST, 'event'));
            pullTenEventButton.addEventListener('click', () => handlePull(10, PULL_TEN_COST, 'event'));
            expandInventoryButton.addEventListener('click', expandInventory);
            autoFillDeckButton.addEventListener('click', autoFillDeck);
            gachaTabNormal.addEventListener('click', () => switchGachaTab('normal'));
            gachaTabEvent.addEventListener('click', () => switchGachaTab('event'));
            
            const cardClickableContainers = [inventoryContainer, deckInventoryContainer, deckSlotsContainer, collectionContainer];
            cardClickableContainers.forEach(container => {
                container.addEventListener('click', (e) => {
                    const actionButton = e.target.closest('[data-action]');
                    if (actionButton) {
                        e.stopPropagation(); // Prevent card detail from opening when a button is clicked
                        const action = actionButton.dataset.action;
                        const cardName = actionButton.dataset.cardName;
						const cardId = actionButton.closest('[data-card-id]')?.dataset.cardId;
                        if (action === 'set-representative') setRepresentative(cardName);
                        else if (action === 'add-to-deck') addToDeck(cardId);
						else if (action === 'remove-from-deck') removeFromDeck(cardId);
                    } else {
                        const cardElement = e.target.closest('[data-card-id]');
                        if (cardElement) {
                             if (container === collectionContainer && cardElement.dataset.isCollected === 'false') {
                                return;
                            }
                            showCardDetails(parseFloat(cardElement.dataset.cardId));
                        }
                    }
                });
            });

            dungeonListContainer.addEventListener('click', (e) => { 
                const button = e.target.closest('[data-action="challenge-dungeon"]');
                if(button) challengeDungeon(parseInt(button.dataset.dungeonIndex), 'main'); 
            });
            homeCharacterContainer.addEventListener('click', () => { if (representativeCharacter) displayHomeView(true); });
            eventBanner.addEventListener('click', () => {
                showMessage(`[${EVENT_CHARACTER_NAME}] í™•ë¥  UP ì´ë²¤íŠ¸ ì§„í–‰ ì¤‘!`, 'text-blue-300', messageArea);
                switchTab('gacha');
            });
            resetButton.addEventListener('click', resetGame);
            closeCombatResultButton.addEventListener('click', () => {
                combatResultModal.classList.add('hidden');
                combatInProgressView.classList.add('hidden');

                if (lastCombatType === 'event') {
                    switchTab('event');
                    displayEventView();
                    switchSubTab(document.getElementById('event-view'), eventSubTabBattle);
                } else { // 'main'
                    switchTab('combat');
                }
            });
            closeCardDetailButton.addEventListener('click', hideCardDetails);
            cardDetailModal.addEventListener('click', (e) => {
                if (e.target === cardDetailModal) hideCardDetails();
            });

            mainStoryContainer.addEventListener('click', (e) => {
                const storyEl = e.target.closest('[data-story-index]');
                if (storyEl) {
                    startInteractiveStory(parseInt(storyEl.dataset.storyIndex), 'main');
				}
			});

            eventStoryContainer.addEventListener('click', (e) => {
                const storyEl = e.target.closest('[data-story-index]');
                if (storyEl) {
                    // ì´ë²¤íŠ¸ ìŠ¤í† ë¦¬ëŠ” ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ì„ì‹œ ì•Œë¦¼ì°½ì„ ë„ì›ë‹ˆë‹¤.
                    alert('ì´ë²¤íŠ¸ ìŠ¤í† ë¦¬ëŠ” í˜„ì¬ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
                }
            });
            eventShopContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button && button.dataset.itemId) {
                    purchaseEventItem(button.dataset.itemId);
                }
            });

            // [ì¶”ê°€] ìƒˆë¡œìš´ ëŒ€í™”í˜• ìŠ¤í† ë¦¬ ëª¨ë‹¬ì˜ ë²„íŠ¼ë“¤ì„ ì—°ê²°í•©ë‹ˆë‹¤.
			storyNextButton.addEventListener('click', advanceStory);
			storySkipButton.addEventListener('click', closeInteractiveStory);

            detailStoryPrevButton.addEventListener('click', () => {
                if (currentStoryPageIndex > 0) {
                    currentStoryPageIndex--;
                    displayCardStoryPage();
                }
            });
            detailStoryNextButton.addEventListener('click', () => {
                if (currentStoryPageIndex < currentStoryPages.length - 1) {
                    currentStoryPageIndex++;
                    displayCardStoryPage();
                }
            });


            speed1xButton.addEventListener('click', () => setCombatSpeed(1));
            speed2xButton.addEventListener('click', () => setCombatSpeed(2));
            speed4xButton.addEventListener('click', () => setCombatSpeed(4));

            eventSubTabBattle.addEventListener('click', () => switchSubTab(document.getElementById('event-view'), eventSubTabBattle));
            eventSubTabStory.addEventListener('click', () => switchSubTab(document.getElementById('event-view'), eventSubTabStory));
            eventSubTabShop.addEventListener('click', () => switchSubTab(document.getElementById('event-view'), eventSubTabShop));
			backToVolumeSelectionButton.addEventListener('click', () => {
                dungeonStageSelection.classList.add('hidden');
                dungeonVolumeSelection.classList.remove('hidden');
            });
            closeEnhancementSuccessButton.addEventListener('click', () => {
                enhancementSuccessModal.classList.add('hidden');
            });
            
            // --- ê²Œì„ ì‹œì‘ ---
            loadGame();
            startBookmarkRegenTimer();
        });
    </script>
</body>
</html>





<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Kside_ (fixed full)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
        body { font-family: 'Jua', sans-serif; background-image: linear-gradient(to top, #30cfd0 0%, #330867 100%); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .card-animation { animation: fadeIn 0.5s ease-out forwards; }
        .rarity-N { background-image: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%); }
        .rarity-R { background-image: linear-gradient(to top, #a1c4fd 0%, #c2ebf0 100%); }
        .rarity-SR { background-image: linear-gradient(to right, #f83292, #7122fa); }
        .rarity-SSR { background-image: linear-gradient(to right, #f78ca0 0%, #f9748f 19%, #fd868c 60%, #fe9a8b 100%); }
        .gacha-button { transition: all 0.3s ease; }
        .gacha-button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); }
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button.active { background-color: #f6e05e; color: #330867; }
        .count-badge { position: absolute; top: -8px; right: -8px; background-color: #e53e3e; color: white; font-size: 14px; font-weight: bold; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; }
        .level-badge { position: absolute; bottom: -8px; left: -8px; background-color: #4299e1; color: white; font-size: 12px; font-weight: bold; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0px 2px 4px rgba(0,0,0,0.3); }
        .deck-slot { border: 2px dashed rgba(255, 255, 255, 0.3); min-height: 120px; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.5); }
        #home-character-image { max-height: 60vh; object-fit: contain; filter: drop-shadow(0px 5px 15px rgba(0,0,0,0.5)); transition: transform 0.3s ease-in-out; }
        #home-character-image:hover { transform: scale(1.03); }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 15px rgba(255, 255, 100, 0.4); } 50% { box-shadow: 0 0 25px rgba(255, 255, 100, 0.8); } }
        #event-banner { animation: pulse-glow 2.5s infinite ease-in-out; }
        .sub-tab-button { transition: all 0.2s ease-in-out; }
        .sub-tab-button.active { background-color: rgba(246, 224, 94, 0.8); color: #330867; }
        #combat-log { scroll-behavior: smooth; }
        .hp-bar-background { background-color: #4a5568; }
        .hp-bar-foreground { background-color: #48bb78; transition: width 0.5s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake-animation { animation: shake 0.3s 1; }
        .speed-button.active { background-color: #4299e1; box-shadow: 0 0 10px rgba(66, 153, 225, 0.7); }
        .story-content { white-space: pre-wrap; word-break: keep-all; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-5xl bg-white/10 backdrop-blur-md rounded-2xl shadow-xl text-white p-6 md:p-8">
        <header class="text-center mb-4">
            <h1 class="text-4xl md:text-5xl font-bold tracking-wider text-yellow-300" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Kside_</h1>
        </header>

        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
            <div class="bg-black/20 rounded-full p-1 flex-shrink-0 flex flex-wrap justify-center">
                <button id="tab-home" class="tab-button active font-bold py-2 px-6 rounded-full">홈</button>
                <button id="tab-event" class="tab-button font-bold py-2 px-6 rounded-full hidden">이벤트</button>
                <button id="tab-gacha" class="tab-button font-bold py-2 px-6 rounded-full">누군가의 서고</button>
                <button id="tab-inventory" class="tab-button font-bold py-2 px-6 rounded-full">당신의 책장</button>
                <button id="tab-deck" class="tab-button font-bold py-2 px-6 rounded-full">편찬</button>
                <button id="tab-combat" class="tab-button font-bold py-2 px-6 rounded-full">독서</button>
                <button id="tab-story" class="tab-button font-bold py-2 px-6 rounded-full">스토리</button>
                <button id="tab-collection" class="tab-button font-bold py-2 px-6 rounded-full">도감</button>
                <button id="tab-achievements" class="tab-button font-bold py-2 px-6 rounded-full">업적</button>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-xl font-bold text-cyan-300 bg-black/20 py-2 px-4 rounded-full inline-block">🔖 <span id="bookmark-display">10</span> / <span id="max-bookmark-display">10</span><span id="bookmark-timer-container" class="text-sm ml-2"></span></div>
                <div class="text-2xl font-bold text-yellow-300 bg-black/20 py-2 px-6 rounded-full inline-block">💎 <span id="currency-display">100</span></div>
                <div class="text-xl font-bold text-gray-300 bg-black/20 py-2 px-4 rounded-full inline-block">🖋️ <span id="fountainpen-display">500</span></div>
                <button id="reset-game" class="gacha-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full text-sm">초기화</button>
            </div>
        </div>

        <main>
            <div id="storage-warning" class="hidden text-center bg-red-500 p-2 rounded-lg mb-4">
                <strong>경고:</strong> 게임 진행 상황을 저장할 수 없습니다. 브라우저가 시크릿 모드이거나 저장 기능이 비활성화되었는지 확인해주세요.
            </div>

            <div id="home-view">
                <div class="relative min-h-[50vh] flex flex-col justify-center items-center text-center p-4">
                    <div id="event-banner" class="hidden absolute top-4 right-4 bg-gradient-to-r from-yellow-400 via-red-500 to-pink-500 p-4 rounded-lg shadow-lg cursor-pointer transform hover:scale-105 transition-transform duration-300 z-10">
                        <h3 class="text-white text-lg font-bold drop-shadow-md">기간 한정 이벤트!</h3>
                        <p id="event-banner-text" class="text-white text-sm drop-shadow-md"></p>
                    </div>

                    <div id="home-character-container" class="flex-grow flex items-center justify-center cursor-pointer">
                        <img id="home-character-image" src="" alt="대표 캐릭터" class="max-w-full">
                    </div>
                    <div id="home-dialogue-container" class="w-full max-w-2xl bg-black/30 backdrop-blur-sm p-4 rounded-xl mt-4">
                        <p id="home-character-name" class="font-bold text-lg text-yellow-300"></p>
                        <p id="home-character-dialogue" class="text-white"></p>
                    </div>
                    <div id="home-default-message" class="text-2xl text-gray-300">보관함에서 대표 등장인물을 설정해주세요!</div>
                </div>
            </div>

            <div id="event-view" class="hidden">
                <!-- (원본 내용 생략 가능) -->
                <p class="text-center">이벤트 공간 (임시)</p>
            </div>

            <div id="gacha-view" class="hidden">
                <p class="text-center text-gray-200 mt-2 mb-4">운명을 시험하여 당신의 등장인물을 만나보세요.</p>
                <div class="bg-black/20 rounded-full p-1 flex justify-center items-center mb-4 max-w-sm mx-auto">
                    <button id="gacha-tab-normal" class="sub-tab-button active w-1/2 font-bold py-2 px-6 rounded-full">일반 뽑기</button>
                    <button id="gacha-tab-event" class="sub-tab-button w-1/2 font-bold py-2 px-6 rounded-full hidden">이벤트 뽑기</button>
                </div>
                <div id="normal-gacha-view">
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-4">
                        <button id="pull-one" class="gacha-button w-full sm:w-auto bg-blue-500 hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">💎 1회 뽑기 (10)</button>
                        <button id="pull-ten" class="gacha-button w-full sm:w-auto bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">💎💎 10회 뽑기 (100)</button>
                    </div>
                </div>
                <div id="message-area" class="text-center text-lg h-8 mb-4 transition-opacity duration-300"></div>
                <div id="results-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[200px] bg-black/20 p-4 rounded-xl"></div>
            </div>

            <div id="inventory-view" class="hidden">
                <div class="text-center mb-4">
                    <p class="text-gray-200">지금까지 수집한 등장인물입니다.</p>
                    <div class="mt-2 flex justify-center items-center gap-4">
                        <p id="inventory-status" class="text-lg font-bold bg-black/20 py-2 px-4 rounded-full"></p>
                        <button id="expand-inventory" class="gacha-button bg-yellow-500 hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed text-black font-bold py-2 px-4 rounded-full shadow-lg text-sm">칸 확장 (💎50)</button>
                    </div>
                </div>
                <div id="inventory-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[400px] max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl"></div>
            </div>

            <div id="deck-view" class="hidden"><p class="text-center">덱 화면 (임시)</p></div>
            <div id="combat-view" class="hidden"><p class="text-center">전투 화면 (임시)</p></div>
            <div id="combat-in-progress-view" class="hidden"><p class="text-center">전투 진행중 (임시)</p></div>
            <div id="collection-view" class="hidden"><p class="text-center">도감 (임시)</p></div>
            <div id="story-view" class="hidden"><p class="text-center">스토리 (임시)</p></div>
            <div id="achievements-view" class="hidden"><div id="achievements-container" class="space-y-3 max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl"></div></div>

            <div id="toast-notification" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-yellow-400 text-black font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 z-50">🎉 업적 달성!</div>

            <div id="card-detail-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-30">
                <div class="bg-gray-800 p-6 rounded-lg max-w-lg w-full relative mx-4 max-h-[90vh] overflow-y-auto">
                    <button id="close-card-detail" class="absolute top-3 right-4 text-white text-3xl font-bold hover:text-gray-400">&times;</button>
                    <div id="detail-card-name" class="text-3xl font-bold"></div>
                </div>
            </div>

            <div id="interactive-story-modal" class="hidden fixed inset-0 bg-black/50 flex flex-col justify-end z-40">
                <div id="dialogue-box" class="relative bg-black/70 backdrop-blur-sm m-4 p-5 rounded-xl border border-white/20 text-white z-10">
                    <h3 id="speaker-name" class="font-bold text-2xl text-yellow-300 mb-2"></h3>
                    <p id="dialogue-text" class="text-lg leading-relaxed h-24"></p>
                    <button id="story-next-button" class="absolute bottom-4 right-5 text-xl animate-pulse">▼ 다음</button>
                </div>
                <button id="story-skip-button" class="absolute top-5 right-5 bg-black/50 text-white py-2 px-4 rounded-full z-20">스킵</button>
            </div>
        </main>
    </div>

    <!-- 기존 game_data.js (사용자 업로드 파일) -->
    <script src="game_data.js"></script>

    <!-- 안정성 강화된 메인 스크립트 -->
    <script>
    // 안전한 초기화: 외부 스크립트(game_data.js)가 실패해도 멈추지 않게 방어적으로 작성
    (function () {
        // 전역 안전 값(외부에서 정의되지 않았을 때)
        window.achievements = window.achievements || [];
        window.synergies = window.synergies || [];
        window.characters = window.characters || [];

        document.addEventListener('DOMContentLoaded', () => {
            try {
                // --- 상수 및 상태 ---
                const MAX_ENHANCEMENT_LEVEL = 9;
                const ENHANCEMENT_COSTS = [5,10,15,25,40,60,85,115,150];
                const STAT_INCREASE_PER_LEVEL = 0.05;
                let playerCurrency = 100;
                let playerFountainPens = 500;
                let playerInventory = [];
                let playerDeck = [];
                let inventoryCapacity = 100;
                let representativeCharacter = null;
                let isCombatRunning = false;
                let combatSpeedMultiplier = 1;
                let clearedDungeons = [];
                let clearedEventDungeons = [];
                let playerEventPoints = 0;
                let purchasedEventItems = {};
                let playerBookmarks = 10;
                const MAX_BOOKMARKS = 10;
                let lastBookmarkUpdateTime = Date.now();
                let playerAchievements = {};
                let playerStats = { totalPulls: 0 };

                const DECK_CAPACITY = 5;
                const PULL_ONE_COST = 10;
                const PULL_TEN_COST = 100;
                const EXPAND_COST = 50;
                const EXPAND_AMOUNT = 10;
                const SAVE_DATA_KEY = 'gachaGameSaveData_v9';

                // --- 안전한 DOM 셀렉션 (널 체크 포함) ---
                function $id(id) { return document.getElementById(id) || null; }
                const fountainPenDisplay = $id('fountainpen-display');
                const currencyDisplay = $id('currency-display');
                const messageArea = $id('message-area');
                const pullOneButton = $id('pull-one');
                const pullTenButton = $id('pull-ten');
                const pullOneEventButton = $id('pull-one-event');
                const pullTenEventButton = $id('pull-ten-event');
                const resultsContainer = $id('results-container');
                const inventoryContainer = $id('inventory-container');
                const inventoryStatus = $id('inventory-status');
                const expandInventoryButton = $id('expand-inventory');
                const deckStatus = $id('deck-status');
                const deckSlotsContainer = $id('deck-slots-container');
                const deckInventoryContainer = $id('deck-inventory-container');
                const autoFillDeckButton = $id('auto-fill-deck');
                const deckPowerDisplay = $id('deck-power-display');
                const homeCharacterContainer = $id('home-character-container');
                const homeCharacterImage = $id('home-character-image');
                const homeDialogueContainer = $id('home-dialogue-container');
                const homeDefaultMessage = $id('home-default-message');
                const homeCharacterName = $id('home-character-name');
                const homeCharacterDialogue = $id('home-character-dialogue');
                const eventBanner = $id('event-banner');
                const eventBannerText = $id('event-banner-text');
                const gachaTabNormal = $id('gacha-tab-normal');
                const gachaTabEvent = $id('gacha-tab-event');
                const normalGachaView = $id('normal-gacha-view');
                const eventGachaView = $id('event-gacha-view');
                const eventGachaInfo = $id('event-gacha-info');
                const resetButton = $id('reset-game');
                const storageWarning = $id('storage-warning');
                const combatInProgressView = $id('combat-in-progress-view');
                const combatPlayerDeck = $id('combat-player-deck');
                const combatMonsterArea = $id('combat-monster-area');
                const combatLogContainer = $id('combat-log-container');
                const combatLog = $id('combat-log');
                const combatResultModal = $id('combat-result-modal');
                const combatResultTitle = $id('combat-result-title');
                const combatResultMessage = $id('combat-result-message');
                const closeCombatResultButton = $id('close-combat-result');
                const cardDetailModal = $id('card-detail-modal');
                const closeCardDetailButton = $id('close-card-detail');
                const speed1xButton = $id('speed-1x');
                const speed2xButton = $id('speed-2x');
                const speed4xButton = $id('speed-4x');
                const collectionContainer = $id('collection-container');
                const mainStoryContainer = $id('main-story-container');
                const eventTab = $id('tab-event');
                const eventPointDisplay = $id('event-point-display');
                const eventPointsSpan = $id('event-points');
                const eventSubTabBattle = $id('event-sub-tab-battle');
                const eventSubTabStory = $id('event-sub-tab-story');
                const eventSubTabShop = $id('event-sub-tab-shop');
                const eventBattleView = $id('event-battle-view');
                const eventStoryView = $id('event-story-view');
                const eventShopView = $id('event-shop-view');
                const eventDungeonListContainer = $id('event-dungeon-list-container');
                const eventStoryContainer = $id('event-story-container');
                const eventShopContainer = $id('event-shop-container');
                const bookmarkDisplay = $id('bookmark-display');
                const maxBookmarkDisplay = $id('max-bookmark-display');
                const bookmarkTimerContainer = $id('bookmark-timer-container');
                const achievementsContainer = $id('achievements-container');
                const toastNotification = $id('toast-notification');
                const synergyList = $id('synergy-list');
                const interactiveStoryModal = $id('interactive-story-modal');
                const storyCharLeft = $id('story-char-left');
                const storyCharRight = $id('story-char-right');
                const speakerName = $id('speaker-name');
                const dialogueText = $id('dialogue-text');
                const storyNextButton = $id('story-next-button');
                const storySkipButton = $id('story-skip-button');
                const detailStoryPrevButton = $id('detail-story-prev');
                const detailStoryNextButton = $id('detail-story-next');

                // --- 유틸리티 함수들 ---
                function logError(e) { console.error('[GAME ERROR]', e); }
                function safeParseJSON(s) { try { return JSON.parse(s); } catch (e) { return null; } }
                function isStorageAvailable() { try { const k='__test__'; localStorage.setItem(k,k); localStorage.removeItem(k); return true; } catch(e) { return false; } }

                // --- 기본 누락 객체 / 배열 초기화(외부에서 안 왔을 때 대비) ---
                window.achievements = window.achievements || [];
                window.synergies = window.synergies || [];
                window.characters = window.characters || [];

                // --- 반드시 필요한 작은 헬퍼들 ---
                function findCharacter(nameOrBase) {
                    if (!nameOrBase) return null;
                    // 시도: 전체 이름 매칭 -> baseName으로 매칭
                    let found = window.characters.find(c => c.name === nameOrBase);
                    if (found) return found;
                    found = window.characters.find(c => c.baseName === nameOrBase);
                    if (found) return found;
                    // 대소문자 / 부분 매칭 허용 (유연하게)
                    found = window.characters.find(c => c.name && c.name.includes(nameOrBase));
                    return found || null;
                }

                function addCardToInventory(nameOrBase) {
                    try {
                        const char = findCharacter(nameOrBase);
                        if (!char) {
                            console.warn('addCardToInventory: 캐릭터를 찾을 수 없음:', nameOrBase);
                            return null;
                        }
                        const newCard = {
                            ...JSON.parse(JSON.stringify(char)), // deep copy
                            uid: 'card_' + Date.now() + '_' + Math.floor(Math.random() * 10000),
                            level: char.level || 1,
                        };
                        playerInventory.push(newCard);
                        saveGame(); // 저장
                        updateUI();
                        return newCard;
                    } catch (e) {
                        logError(e);
                        return null;
                    }
                }

                // 안전한 calculateActiveSynergies: 입력이 없거나 synergies 배열 구조를 모를 때 빈 배열 반환
                function calculateActiveSynergies(deck) {
                    try {
                        if (!Array.isArray(window.synergies) || window.synergies.length === 0) return [];
                        if (!Array.isArray(deck) || deck.length === 0) return [];
                        // 기본: synergies 배열이 { ids: [baseName...], effect: '...' } 같은 구조일 때 활성화 여부 계산
                        const active = [];
                        window.synergies.forEach(s => {
                            if (!s.ids || !Array.isArray(s.ids)) return;
                            const matches = s.ids.every(id => deck.some(card => card.baseName === id || card.name === id));
                            if (matches) active.push(s);
                        });
                        return active;
                    } catch (e) {
                        logError(e);
                        return [];
                    }
                }

                // --- 저장 / 불러오기 ---
                function saveGame() {
                    if (!isStorageAvailable()) return;
                    try {
                        const saveData = {
                            currency: playerCurrency,
                            fountainPens: playerFountainPens,
                            inventory: playerInventory,
                            deck: playerDeck.map(c => c.uid || c.id || null).filter(Boolean),
                            capacity: inventoryCapacity,
                            representative: representativeCharacter ? (representativeCharacter.name || representativeCharacter.baseName) : null,
                            clearedDungeons, clearedEventDungeons, purchasedEventItems, playerEventPoints,
                            bookmarks: playerBookmarks, lastBookmarkUpdateTime, achievements: playerAchievements, stats: playerStats
                        };
                        localStorage.setItem(SAVE_DATA_KEY, JSON.stringify(saveData));
                    } catch(e) {
                        logError(e);
                    }
                }

                function loadGame() {
                    try {
                        if (!isStorageAvailable()) {
                            if (storageWarning) storageWarning.classList.remove('hidden');
                            // 초기 데이터라도 채움
                            initializeNewGameData();
                            return;
                        }
                        const raw = localStorage.getItem(SAVE_DATA_KEY);
                        if (!raw) {
                            initializeNewGameData();
                            saveGame();
                            return;
                        }
                        const parsed = safeParseJSON(raw);
                        if (!parsed) { initializeNewGameData(); return; }
                        playerCurrency = parsed.currency ?? playerCurrency;
                        playerFountainPens = parsed.fountainPens ?? playerFountainPens;
                        inventoryCapacity = parsed.capacity ?? inventoryCapacity;
                        playerBookmarks = parsed.bookmarks ?? playerBookmarks;
                        lastBookmarkUpdateTime = parsed.lastBookmarkUpdateTime ?? lastBookmarkUpdateTime;
                        playerAchievements = parsed.achievements || playerAchievements;
                        playerStats = parsed.stats || playerStats;
                        // inventory: try to map saved entries to characters (if saved as name/base)
                        if (Array.isArray(parsed.inventory) && parsed.inventory.length > 0) {
                            playerInventory = parsed.inventory.map(it => {
                                // If it's a whole object from previous save, keep it
                                if (it && it.name) return it;
                                // if it's an id/name, try to find character
                                const c = findCharacter(it) || window.characters.find(ch => ch.name === it || ch.baseName === it);
                                if (c) return { ...JSON.parse(JSON.stringify(c)), uid: 'card_' + Date.now() + '_' + Math.floor(Math.random()*10000) };
                                return null;
                            }).filter(Boolean);
                        }
                        // deck restore minimal
                        if (Array.isArray(parsed.deck)) {
                            playerDeck = parsed.deck.map(id => playerInventory.find(card => card.uid === id || card.id === id)).filter(Boolean);
                        }
                    } catch (e) {
                        logError(e);
                        initializeNewGameData();
                    }
                }

                function initializeNewGameData() {
                    try {
                        // 기본 지급 카드 (원본과 동일한 이름 사용)
                        playerInventory = [];
                        addCardToInventory('[편집자] 윤필규');
                        addCardToInventory('[조수] 한 현');
                        playerBookmarks = MAX_BOOKMARKS;
                        lastBookmarkUpdateTime = Date.now();
                        saveGame();
                    } catch (e) {
                        logError(e);
                    }
                }

                function resetGame() {
                    try {
                        if (!isStorageAvailable()) return;
                        if (resetButton) {
                            if (resetButton.dataset.confirming === 'true') {
                                localStorage.removeItem(SAVE_DATA_KEY);
                                location.reload();
                            } else {
                                resetButton.textContent = '확인?';
                                resetButton.dataset.confirming = 'true';
                                resetButton.classList.remove('bg-red-600','hover:bg-red-700');
                                resetButton.classList.add('bg-yellow-500','hover:bg-yellow-600');
                                setTimeout(() => {
                                    resetButton.textContent = '초기화';
                                    resetButton.dataset.confirming = 'false';
                                    resetButton.classList.remove('bg-yellow-500','hover:bg-yellow-600');
                                    resetButton.classList.add('bg-red-600','hover:bg-red-700');
                                }, 3000);
                            }
                        } else {
                            localStorage.removeItem(SAVE_DATA_KEY);
                            location.reload();
                        }
                    } catch (e) {
                        logError(e);
                    }
                }

                // --- UI 업데이트 / 탭 제어 ---
                const tabButtons = Array.from(document.querySelectorAll('.tab-button'));
                // 올바른 allViews selector: interactive-story-modal 존재하므로 그걸 제외
                const allViews = Array.from(document.querySelectorAll('main > div:not(#interactive-story-modal)'));

                function updateUI() {
                    try {
                        if (currencyDisplay) currencyDisplay.textContent = String(playerCurrency);
                        if (fountainPenDisplay) fountainPenDisplay.textContent = String(playerFountainPens);
                        if (bookmarkDisplay) bookmarkDisplay.textContent = String(playerBookmarks);
                        if (maxBookmarkDisplay) maxBookmarkDisplay.textContent = String(MAX_BOOKMARKS);
                        // inventory UI
                        if (inventoryContainer) {
                            inventoryContainer.innerHTML = '';
                            playerInventory.forEach(card => {
                                const el = document.createElement('div');
                                el.className = 'relative p-3 bg-black/10 rounded-lg text-white';
                                el.innerHTML = `
                                    <div class="font-bold">${card.name}</div>
                                    <div class="text-sm text-gray-300">Lv.${card.level || 1} • ${card.rarity || ''}</div>
                                `;
                                el.addEventListener('click', () => {
                                    showCardDetail(card);
                                });
                                inventoryContainer.appendChild(el);
                            });
                            if (inventoryStatus) inventoryStatus.textContent = `${playerInventory.length} / ${inventoryCapacity}`;
                        }
                        // results container: keep as is
                        // achievements
                        if (achievementsContainer) {
                            displayAchievements();
                        }
                    } catch (e) {
                        logError(e);
                    }
                }

                function switchTab(tabName) {
                    try {
                        // normalize: tabName could be 'home' (from id 'tab-home')
                        tabButtons.forEach(btn => {
                            btn.classList.remove('active','bg-yellow-400','text-indigo-900');
                            btn.classList.add('bg-gray-600');
                        });
                        allViews.forEach(v => v.classList.add('hidden'));
                        const tabButton = document.getElementById(`tab-${tabName}`);
                        const view = document.getElementById(`${tabName}-view`);
                        if (tabButton) {
                            tabButton.classList.add('active','bg-yellow-400','text-indigo-900');
                            tabButton.classList.remove('bg-gray-600');
                        }
                        if (view) view.classList.remove('hidden');
                    } catch (e) {
                        logError(e);
                    }
                }

                function checkEventStatus() {
                    // placeholder — 이벤트 활성화/비활성화 체크
                    try {
                        if (!eventBanner) return;
                        // 예시: no event => 숨김
                        eventBanner.classList.add('hidden');
                    } catch (e) { logError(e); }
                }

                // --- 업적 처리(간단) ---
                function displayAchievements() {
                    try {
                        if (!achievementsContainer) return;
                        achievementsContainer.innerHTML = '';
                        window.achievements.forEach(ach => {
                            const status = playerAchievements[ach.id] || null;
                            const achEl = document.createElement('div');
                            achEl.className = `p-4 rounded-lg flex justify-between items-center transition-all ${status ? 'bg-white/20' : 'bg-black/30 opacity-60'}`;
                            let rewardText = '';
                            if (ach.reward) {
                                if (ach.reward.currency) rewardText += `💎 ${ach.reward.currency} `;
                                if (ach.reward.bookmarks) rewardText += `🔖 ${ach.reward.bookmarks}`;
                            }
                            let buttonHTML = '';
                            if (status === 'claimed') {
                                buttonHTML = `<button class="gacha-button bg-gray-600 text-white font-bold py-2 px-4 rounded-full text-sm" disabled>달성 완료</button>`;
                            } else if (status === 'unlocked') {
                                buttonHTML = `<button data-ach-id="${ach.id}" class="claim-ach gacha-button bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full text-sm">보상 받기</button>`;
                            } else {
                                buttonHTML = `<button class="gacha-button bg-gray-800 text-gray-400 font-bold py-2 px-4 rounded-full text-sm" disabled>진행 중</button>`;
                            }
                            achEl.innerHTML = `
                                <div>
                                    <h3 class="text-lg font-bold ${status ? 'text-yellow-300' : 'text-gray-400'}">${ach.title}</h3>
                                    <p class="text-sm text-gray-300">${ach.description} (보상: ${rewardText})</p>
                                </div>
                                ${buttonHTML}
                            `;
                            achievementsContainer.appendChild(achEl);
                        });
                        // attach claim handlers (delegation)
                        achievementsContainer.querySelectorAll('.claim-ach').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const id = btn.dataset['achId'];
                                claimAchievement(id);
                            });
                        });
                    } catch (e) { logError(e); }
                }

                function claimAchievement(id) {
                    try {
                        const ach = window.achievements.find(a => a.id === id);
                        if (!ach) return;
                        if (playerAchievements[id] !== 'unlocked') return;
                        if (ach.reward) {
                            if (ach.reward.currency) playerCurrency += ach.reward.currency;
                            if (ach.reward.bookmarks) playerBookmarks = Math.min(MAX_BOOKMARKS, playerBookmarks + ach.reward.bookmarks);
                        }
                        playerAchievements[id] = 'claimed';
                        saveGame();
                        updateUI();
                    } catch (e) { logError(e); }
                }

                // --- 카드 상세 모달 ---
                function showCardDetail(card) {
                    try {
                        if (!cardDetailModal) return;
                        const nameEl = $id('detail-card-name');
                        if (nameEl) nameEl.textContent = card.name;
                        cardDetailModal.classList.remove('hidden');
                    } catch (e) { logError(e); }
                }

                function closeCardDetail() {
                    try {
                        if (!cardDetailModal) return;
                        cardDetailModal.classList.add('hidden');
                    } catch (e) { logError(e); }
                }

                // --- 뽑기 기능 (간단/동작 우선) ---
                function showResult(cards) {
                    try {
                        if (!resultsContainer) return;
                        resultsContainer.innerHTML = '';
                        cards.forEach(c => {
                            const el = document.createElement('div');
                            el.className = 'p-3 bg-black/20 rounded text-center';
                            el.textContent = c.name || 'Unknown';
                            resultsContainer.appendChild(el);
                        });
                    } catch (e) { logError(e); }
                }

                function pullOne() {
                    try {
                        if (playerCurrency < PULL_ONE_COST) {
                            if (messageArea) messageArea.textContent = '재화가 부족합니다.';
                            return;
                        }
                        playerCurrency -= PULL_ONE_COST;
                        const pool = window.characters.length ? window.characters : [{name:'[빈 슬롯]'}];
                        const picked = pool[Math.floor(Math.random() * pool.length)];
                        const newCard = addCardToInventory(picked.name || picked.baseName || picked);
                        playerStats.totalPulls = (playerStats.totalPulls || 0) + 1;
                        saveGame();
                        updateUI();
                        showResult([picked]);
                    } catch (e) { logError(e); }
                }

                function pullTen() {
                    try {
                        if (playerCurrency < PULL_TEN_COST) {
                            if (messageArea) messageArea.textContent = '재화가 부족합니다.';
                            return;
                        }
                        playerCurrency -= PULL_TEN_COST;
                        const pool = window.characters.length ? window.characters : [{name:'[빈 슬롯]'}];
                        const pulled = [];
                        for (let i=0;i<10;i++){
                            const p = pool[Math.floor(Math.random() * pool.length)];
                            addCardToInventory(p.name || p.baseName || p);
                            pulled.push(p);
                        }
                        playerStats.totalPulls = (playerStats.totalPulls || 0) + 10;
                        saveGame();
                        updateUI();
                        showResult(pulled);
                    } catch (e) { logError(e); }
                }

                // --- 이벤트 바인딩 (안전하게) ---
                if (pullOneButton) pullOneButton.addEventListener('click', pullOne);
                if (pullTenButton) pullTenButton.addEventListener('click', pullTen);
                if (resetButton) resetButton.addEventListener('click', resetGame);
                if (closeCardDetailButton) closeCardDetailButton.addEventListener('click', closeCardDetail);

                // 탭 바인딩
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        try {
                            const id = btn.id;
                            if (!id) return;
                            const key = id.replace(/^tab-/, '');
                            switchTab(key);
                        } catch (e) { logError(e); }
                    });
                });

                // 카드 더블 클릭 혹은 기타 안전 이벤트는 필요시 추가

                // --- 초기 로드 ---
                loadGame();
                updateUI();
                checkEventStatus();
                switchTab('home');

                // --- 진단 출력: 만약 클릭이 안되면 콘솔 확인하라고 안내 ---
                console.info('Game initialized. If UI not responding, check Console for errors.');
            } catch (e) {
                console.error('Fatal initialization error:', e);
                alert('스크립트 초기화 중 치명적 오류가 발생했습니다. 콘솔을 확인하세요.');
            }
        });
    })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Kside_ (fixed full)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
        body { font-family: 'Jua', sans-serif; background-image: linear-gradient(to top, #30cfd0 0%, #330867 100%); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .card-animation { animation: fadeIn 0.5s ease-out forwards; }
        .rarity-N { background-image: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%); }
        .rarity-R { background-image: linear-gradient(to top, #a1c4fd 0%, #c2ebf0 100%); }
        .rarity-SR { background-image: linear-gradient(to right, #f83292, #7122fa); }
        .rarity-SSR { background-image: linear-gradient(to right, #f78ca0 0%, #f9748f 19%, #fd868c 60%, #fe9a8b 100%); }
        .gacha-button { transition: all 0.3s ease; }
        .gacha-button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); }
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button.active { background-color: #f6e05e; color: #330867; }
        .count-badge { position: absolute; top: -8px; right: -8px; background-color: #e53e3e; color: white; font-size: 14px; font-weight: bold; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; }
        .level-badge { position: absolute; bottom: -8px; left: -8px; background-color: #4299e1; color: white; font-size: 12px; font-weight: bold; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0px 2px 4px rgba(0,0,0,0.3); }
        .deck-slot { border: 2px dashed rgba(255, 255, 255, 0.3); min-height: 120px; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.5); }
        #home-character-image { max-height: 60vh; object-fit: contain; filter: drop-shadow(0px 5px 15px rgba(0,0,0,0.5)); transition: transform 0.3s ease-in-out; }
        #home-character-image:hover { transform: scale(1.03); }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 15px rgba(255, 255, 100, 0.4); } 50% { box-shadow: 0 0 25px rgba(255, 255, 100, 0.8); } }
        #event-banner { animation: pulse-glow 2.5s infinite ease-in-out; }
        .sub-tab-button { transition: all 0.2s ease-in-out; }
        .sub-tab-button.active { background-color: rgba(246, 224, 94, 0.8); color: #330867; }
        #combat-log { scroll-behavior: smooth; }
        .hp-bar-background { background-color: #4a5568; }
        .hp-bar-foreground { background-color: #48bb78; transition: width 0.5s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake-animation { animation: shake 0.3s 1; }
        .speed-button.active { background-color: #4299e1; box-shadow: 0 0 10px rgba(66, 153, 225, 0.7); }
        .story-content { white-space: pre-wrap; word-break: keep-all; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-5xl bg-white/10 backdrop-blur-md rounded-2xl shadow-xl text-white p-6 md:p-8">
        <header class="text-center mb-4">
            <h1 class="text-4xl md:text-5xl font-bold tracking-wider text-yellow-300" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Kside_</h1>
        </header>

        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
            <div class="bg-black/20 rounded-full p-1 flex-shrink-0 flex flex-wrap justify-center">
                <button id="tab-home" class="tab-button active font-bold py-2 px-6 rounded-full">í™ˆ</button>
                <button id="tab-event" class="tab-button font-bold py-2 px-6 rounded-full hidden">ì´ë²¤íŠ¸</button>
                <button id="tab-gacha" class="tab-button font-bold py-2 px-6 rounded-full">ëˆ„êµ°ê°€ì˜ ì„œê³ </button>
                <button id="tab-inventory" class="tab-button font-bold py-2 px-6 rounded-full">ë‹¹ì‹ ì˜ ì±…ì¥</button>
                <button id="tab-deck" class="tab-button font-bold py-2 px-6 rounded-full">í¸ì°¬</button>
                <button id="tab-combat" class="tab-button font-bold py-2 px-6 rounded-full">ë…ì„œ</button>
                <button id="tab-story" class="tab-button font-bold py-2 px-6 rounded-full">ìŠ¤í† ë¦¬</button>
                <button id="tab-collection" class="tab-button font-bold py-2 px-6 rounded-full">ë„ê°</button>
                <button id="tab-achievements" class="tab-button font-bold py-2 px-6 rounded-full">ì—…ì </button>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-xl font-bold text-cyan-300 bg-black/20 py-2 px-4 rounded-full inline-block">ğŸ”– <span id="bookmark-display">10</span> / <span id="max-bookmark-display">10</span><span id="bookmark-timer-container" class="text-sm ml-2"></span></div>
                <div class="text-2xl font-bold text-yellow-300 bg-black/20 py-2 px-6 rounded-full inline-block">ğŸ’ <span id="currency-display">100</span></div>
                <div class="text-xl font-bold text-gray-300 bg-black/20 py-2 px-4 rounded-full inline-block">ğŸ–‹ï¸ <span id="fountainpen-display">500</span></div>
                <button id="reset-game" class="gacha-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full text-sm">ì´ˆê¸°í™”</button>
            </div>
        </div>

        <main>
            <div id="storage-warning" class="hidden text-center bg-red-500 p-2 rounded-lg mb-4">
                <strong>ê²½ê³ :</strong> ê²Œì„ ì§„í–‰ ìƒí™©ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ê°€ ì‹œí¬ë¦¿ ëª¨ë“œì´ê±°ë‚˜ ì €ì¥ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.
            </div>

            <div id="home-view">
                <div class="relative min-h-[50vh] flex flex-col justify-center items-center text-center p-4">
                    <div id="event-banner" class="hidden absolute top-4 right-4 bg-gradient-to-r from-yellow-400 via-red-500 to-pink-500 p-4 rounded-lg shadow-lg cursor-pointer transform hover:scale-105 transition-transform duration-300 z-10">
                        <h3 class="text-white text-lg font-bold drop-shadow-md">ê¸°ê°„ í•œì • ì´ë²¤íŠ¸!</h3>
                        <p id="event-banner-text" class="text-white text-sm drop-shadow-md"></p>
                    </div>

                    <div id="home-character-container" class="flex-grow flex items-center justify-center cursor-pointer">
                        <img id="home-character-image" src="" alt="ëŒ€í‘œ ìºë¦­í„°" class="max-w-full">
                    </div>
                    <div id="home-dialogue-container" class="w-full max-w-2xl bg-black/30 backdrop-blur-sm p-4 rounded-xl mt-4">
                        <p id="home-character-name" class="font-bold text-lg text-yellow-300"></p>
                        <p id="home-character-dialogue" class="text-white"></p>
                    </div>
                    <div id="home-default-message" class="text-2xl text-gray-300">ë³´ê´€í•¨ì—ì„œ ëŒ€í‘œ ë“±ì¥ì¸ë¬¼ì„ ì„¤ì •í•´ì£¼ì„¸ìš”!</div>
                </div>
            </div>

            <div id="event-view" class="hidden">
                <!-- (ì›ë³¸ ë‚´ìš© ìƒëµ ê°€ëŠ¥) -->
                <p class="text-center">ì´ë²¤íŠ¸ ê³µê°„ (ì„ì‹œ)</p>
            </div>

            <div id="gacha-view" class="hidden">
                <p class="text-center text-gray-200 mt-2 mb-4">ìš´ëª…ì„ ì‹œí—˜í•˜ì—¬ ë‹¹ì‹ ì˜ ë“±ì¥ì¸ë¬¼ì„ ë§Œë‚˜ë³´ì„¸ìš”.</p>
                <div class="bg-black/20 rounded-full p-1 flex justify-center items-center mb-4 max-w-sm mx-auto">
                    <button id="gacha-tab-normal" class="sub-tab-button active w-1/2 font-bold py-2 px-6 rounded-full">ì¼ë°˜ ë½‘ê¸°</button>
                    <button id="gacha-tab-event" class="sub-tab-button w-1/2 font-bold py-2 px-6 rounded-full hidden">ì´ë²¤íŠ¸ ë½‘ê¸°</button>
                </div>
                <div id="normal-gacha-view">
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-4">
                        <button id="pull-one" class="gacha-button w-full sm:w-auto bg-blue-500 hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">ğŸ’ 1íšŒ ë½‘ê¸° (10)</button>
                        <button id="pull-ten" class="gacha-button w-full sm:w-auto bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">ğŸ’ğŸ’ 10íšŒ ë½‘ê¸° (100)</button>
                    </div>
                </div>
                <div id="message-area" class="text-center text-lg h-8 mb-4 transition-opacity duration-300"></div>
                <div id="results-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[200px] bg-black/20 p-4 rounded-xl"></div>
            </div>

            <div id="inventory-view" class="hidden">
                <div class="text-center mb-4">
                    <p class="text-gray-200">ì§€ê¸ˆê¹Œì§€ ìˆ˜ì§‘í•œ ë“±ì¥ì¸ë¬¼ì…ë‹ˆë‹¤.</p>
                    <div class="mt-2 flex justify-center items-center gap-4">
                        <p id="inventory-status" class="text-lg font-bold bg-black/20 py-2 px-4 rounded-full"></p>
                        <button id="expand-inventory" class="gacha-button bg-yellow-500 hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed text-black font-bold py-2 px-4 rounded-full shadow-lg text-sm">ì¹¸ í™•ì¥ (ğŸ’50)</button>
                    </div>
                </div>
                <div id="inventory-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[400px] max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl"></div>
            </div>

            <div id="deck-view" class="hidden"><p class="text-center">ë± í™”ë©´ (ì„ì‹œ)</p></div>
            <div id="combat-view" class="hidden"><p class="text-center">ì „íˆ¬ í™”ë©´ (ì„ì‹œ)</p></div>
            <div id="combat-in-progress-view" class="hidden"><p class="text-center">ì „íˆ¬ ì§„í–‰ì¤‘ (ì„ì‹œ)</p></div>
            <div id="collection-view" class="hidden"><p class="text-center">ë„ê° (ì„ì‹œ)</p></div>
            <div id="story-view" class="hidden"><p class="text-center">ìŠ¤í† ë¦¬ (ì„ì‹œ)</p></div>
            <div id="achievements-view" class="hidden"><div id="achievements-container" class="space-y-3 max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl"></div></div>

            <div id="toast-notification" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-yellow-400 text-black font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 z-50">ğŸ‰ ì—…ì  ë‹¬ì„±!</div>

            <div id="card-detail-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-30">
                <div class="bg-gray-800 p-6 rounded-lg max-w-lg w-full relative mx-4 max-h-[90vh] overflow-y-auto">
                    <button id="close-card-detail" class="absolute top-3 right-4 text-white text-3xl font-bold hover:text-gray-400">&times;</button>
                    <div id="detail-card-name" class="text-3xl font-bold"></div>
                </div>
            </div>

            <div id="interactive-story-modal" class="hidden fixed inset-0 bg-black/50 flex flex-col justify-end z-40">
                <div id="dialogue-box" class="relative bg-black/70 backdrop-blur-sm m-4 p-5 rounded-xl border border-white/20 text-white z-10">
                    <h3 id="speaker-name" class="font-bold text-2xl text-yellow-300 mb-2"></h3>
                    <p id="dialogue-text" class="text-lg leading-relaxed h-24"></p>
                    <button id="story-next-button" class="absolute bottom-4 right-5 text-xl animate-pulse">â–¼ ë‹¤ìŒ</button>
                </div>
                <button id="story-skip-button" class="absolute top-5 right-5 bg-black/50 text-white py-2 px-4 rounded-full z-20">ìŠ¤í‚µ</button>
            </div>
        </main>
    </div>

    <!-- ê¸°ì¡´ game_data.js (ì‚¬ìš©ì ì—…ë¡œë“œ íŒŒì¼) -->
    <script src="game_data.js"></script>

    <!-- ì•ˆì •ì„± ê°•í™”ëœ ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
    // ì•ˆì „í•œ ì´ˆê¸°í™”: ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸(game_data.js)ê°€ ì‹¤íŒ¨í•´ë„ ë©ˆì¶”ì§€ ì•Šê²Œ ë°©ì–´ì ìœ¼ë¡œ ì‘ì„±
    (function () {
        // ì „ì—­ ì•ˆì „ ê°’(ì™¸ë¶€ì—ì„œ ì •ì˜ë˜ì§€ ì•Šì•˜ì„ ë•Œ)
        window.achievements = window.achievements || [];
        window.synergies = window.synergies || [];
        window.characters = window.characters || [];

        document.addEventListener('DOMContentLoaded', () => {
            try {
                // --- ìƒìˆ˜ ë° ìƒíƒœ ---
                const MAX_ENHANCEMENT_LEVEL = 9;
                const ENHANCEMENT_COSTS = [5,10,15,25,40,60,85,115,150];
                const STAT_INCREASE_PER_LEVEL = 0.05;
                let playerCurrency = 100;
                let playerFountainPens = 500;
                let playerInventory = [];
                let playerDeck = [];
                let inventoryCapacity = 100;
                let representativeCharacter = null;
                let isCombatRunning = false;
                let combatSpeedMultiplier = 1;
                let clearedDungeons = [];
                let clearedEventDungeons = [];
                let playerEventPoints = 0;
                let purchasedEventItems = {};
                let playerBookmarks = 10;
                const MAX_BOOKMARKS = 10;
                let lastBookmarkUpdateTime = Date.now();
                let playerAchievements = {};
                let playerStats = { totalPulls: 0 };

                const DECK_CAPACITY = 5;
                const PULL_ONE_COST = 10;
                const PULL_TEN_COST = 100;
                const EXPAND_COST = 50;
                const EXPAND_AMOUNT = 10;
                const SAVE_DATA_KEY = 'gachaGameSaveData_v9';

                // --- ì•ˆì „í•œ DOM ì…€ë ‰ì…˜ (ë„ ì²´í¬ í¬í•¨) ---
                function $id(id) { return document.getElementById(id) || null; }
                const fountainPenDisplay = $id('fountainpen-display');
                const currencyDisplay = $id('currency-display');
                const messageArea = $id('message-area');
                const pullOneButton = $id('pull-one');
                const pullTenButton = $id('pull-ten');
                const pullOneEventButton = $id('pull-one-event');
                const pullTenEventButton = $id('pull-ten-event');
                const resultsContainer = $id('results-container');
                const inventoryContainer = $id('inventory-container');
                const inventoryStatus = $id('inventory-status');
                const expandInventoryButton = $id('expand-inventory');
                const deckStatus = $id('deck-status');
                const deckSlotsContainer = $id('deck-slots-container');
                const deckInventoryContainer = $id('deck-inventory-container');
                const autoFillDeckButton = $id('auto-fill-deck');
                const deckPowerDisplay = $id('deck-power-display');
                const homeCharacterContainer = $id('home-character-container');
                const homeCharacterImage = $id('home-character-image');
                const homeDialogueContainer = $id('home-dialogue-container');
                const homeDefaultMessage = $id('home-default-message');
                const homeCharacterName = $id('home-character-name');
                const homeCharacterDialogue = $id('home-character-dialogue');
                const eventBanner = $id('event-banner');
                const eventBannerText = $id('event-banner-text');
                const gachaTabNormal = $id('gacha-tab-normal');
                const gachaTabEvent = $id('gacha-tab-event');
                const normalGachaView = $id('normal-gacha-view');
                const eventGachaView = $id('event-gacha-view');
                const eventGachaInfo = $id('event-gacha-info');
                const resetButton = $id('reset-game');
                const storageWarning = $id('storage-warning');
                const combatInProgressView = $id('combat-in-progress-view');
                const combatPlayerDeck = $id('combat-player-deck');
                const combatMonsterArea = $id('combat-monster-area');
                const combatLogContainer = $id('combat-log-container');
                const combatLog = $id('combat-log');
                const combatResultModal = $id('combat-result-modal');
                const combatResultTitle = $id('combat-result-title');
                const combatResultMessage = $id('combat-result-message');
                const closeCombatResultButton = $id('close-combat-result');
                const cardDetailModal = $id('card-detail-modal');
                const closeCardDetailButton = $id('close-card-detail');
                const speed1xButton = $id('speed-1x');
                const speed2xButton = $id('speed-2x');
                const speed4xButton = $id('speed-4x');
                const collectionContainer = $id('collection-container');
                const mainStoryContainer = $id('main-story-container');
                const eventTab = $id('tab-event');
                const eventPointDisplay = $id('event-point-display');
                const eventPointsSpan = $id('event-points');
                const eventSubTabBattle = $id('event-sub-tab-battle');
                const eventSubTabStory = $id('event-sub-tab-story');
                const eventSubTabShop = $id('event-sub-tab-shop');
                const eventBattleView = $id('event-battle-view');
                const eventStoryView = $id('event-story-view');
                const eventShopView = $id('event-shop-view');
                const eventDungeonListContainer = $id('event-dungeon-list-container');
                const eventStoryContainer = $id('event-story-container');
                const eventShopContainer = $id('event-shop-container');
                const bookmarkDisplay = $id('bookmark-display');
                const maxBookmarkDisplay = $id('max-bookmark-display');
                const bookmarkTimerContainer = $id('bookmark-timer-container');
                const achievementsContainer = $id('achievements-container');
                const toastNotification = $id('toast-notification');
                const synergyList = $id('synergy-list');
                const interactiveStoryModal = $id('interactive-story-modal');
                const storyCharLeft = $id('story-char-left');
                const storyCharRight = $id('story-char-right');
                const speakerName = $id('speaker-name');
                const dialogueText = $id('dialogue-text');
                const storyNextButton = $id('story-next-button');
                const storySkipButton = $id('story-skip-button');
                const detailStoryPrevButton = $id('detail-story-prev');
                const detailStoryNextButton = $id('detail-story-next');

                // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ---
                function logError(e) { console.error('[GAME ERROR]', e); }
                function safeParseJSON(s) { try { return JSON.parse(s); } catch (e) { return null; } }
                function isStorageAvailable() { try { const k='__test__'; localStorage.setItem(k,k); localStorage.removeItem(k); return true; } catch(e) { return false; } }

                // --- ê¸°ë³¸ ëˆ„ë½ ê°ì²´ / ë°°ì—´ ì´ˆê¸°í™”(ì™¸ë¶€ì—ì„œ ì•ˆ ì™”ì„ ë•Œ ëŒ€ë¹„) ---
                window.achievements = window.achievements || [];
                window.synergies = window.synergies || [];
                window.characters = window.characters || [];

                // --- ë°˜ë“œì‹œ í•„ìš”í•œ ì‘ì€ í—¬í¼ë“¤ ---
                function findCharacter(nameOrBase) {
                    if (!nameOrBase) return null;
                    // ì‹œë„: ì „ì²´ ì´ë¦„ ë§¤ì¹­ -> baseNameìœ¼ë¡œ ë§¤ì¹­
                    let found = window.characters.find(c => c.name === nameOrBase);
                    if (found) return found;
                    found = window.characters.find(c => c.baseName === nameOrBase);
                    if (found) return found;
                    // ëŒ€ì†Œë¬¸ì / ë¶€ë¶„ ë§¤ì¹­ í—ˆìš© (ìœ ì—°í•˜ê²Œ)
                    found = window.characters.find(c => c.name && c.name.includes(nameOrBase));
                    return found || null;
                }

                function addCardToInventory(nameOrBase) {
                    try {
                        const char = findCharacter(nameOrBase);
                        if (!char) {
                            console.warn('addCardToInventory: ìºë¦­í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', nameOrBase);
                            return null;
                        }
                        const newCard = {
                            ...JSON.parse(JSON.stringify(char)), // deep copy
                            uid: 'card_' + Date.now() + '_' + Math.floor(Math.random() * 10000),
                            level: char.level || 1,
                        };
                        playerInventory.push(newCard);
                        saveGame(); // ì €ì¥
                        updateUI();
                        return newCard;
                    } catch (e) {
                        logError(e);
                        return null;
                    }
                }

                // ì•ˆì „í•œ calculateActiveSynergies: ì…ë ¥ì´ ì—†ê±°ë‚˜ synergies ë°°ì—´ êµ¬ì¡°ë¥¼ ëª¨ë¥¼ ë•Œ ë¹ˆ ë°°ì—´ ë°˜í™˜
                function calculateActiveSynergies(deck) {
                    try {
                        if (!Array.isArray(window.synergies) || window.synergies.length === 0) return [];
                        if (!Array.isArray(deck) || deck.length === 0) return [];
                        // ê¸°ë³¸: synergies ë°°ì—´ì´ { ids: [baseName...], effect: '...' } ê°™ì€ êµ¬ì¡°ì¼ ë•Œ í™œì„±í™” ì—¬ë¶€ ê³„ì‚°
                        const active = [];
                        window.synergies.forEach(s => {
                            if (!s.ids || !Array.isArray(s.ids)) return;
                            const matches = s.ids.every(id => deck.some(card => card.baseName === id || card.name === id));
                            if (matches) active.push(s);
                        });
                        return active;
                    } catch (e) {
                        logError(e);
                        return [];
                    }
                }

                // --- ì €ì¥ / ë¶ˆëŸ¬ì˜¤ê¸° ---
                function saveGame() {
                    if (!isStorageAvailable()) return;
                    try {
                        const saveData = {
                            currency: playerCurrency,
                            fountainPens: playerFountainPens,
                            inventory: playerInventory,
                            deck: playerDeck.map(c => c.uid || c.id || null).filter(Boolean),
                            capacity: inventoryCapacity,
                            representative: representativeCharacter ? (representativeCharacter.name || representativeCharacter.baseName) : null,
                            clearedDungeons, clearedEventDungeons, purchasedEventItems, playerEventPoints,
                            bookmarks: playerBookmarks, lastBookmarkUpdateTime, achievements: playerAchievements, stats: playerStats
                        };
                        localStorage.setItem(SAVE_DATA_KEY, JSON.stringify(saveData));
                    } catch(e) {
                        logError(e);
                    }
                }

                function loadGame() {
                    try {
                        if (!isStorageAvailable()) {
                            if (storageWarning) storageWarning.classList.remove('hidden');
                            // ì´ˆê¸° ë°ì´í„°ë¼ë„ ì±„ì›€
                            initializeNewGameData();
                            return;
                        }
                        const raw = localStorage.getItem(SAVE_DATA_KEY);
                        if (!raw) {
                            initializeNewGameData();
                            saveGame();
                            return;
                        }
                        const parsed = safeParseJSON(raw);
                        if (!parsed) { initializeNewGameData(); return; }
                        playerCurrency = parsed.currency ?? playerCurrency;
                        playerFountainPens = parsed.fountainPens ?? playerFountainPens;
                        inventoryCapacity = parsed.capacity ?? inventoryCapacity;
                        playerBookmarks = parsed.bookmarks ?? playerBookmarks;
                        lastBookmarkUpdateTime = parsed.lastBookmarkUpdateTime ?? lastBookmarkUpdateTime;
                        playerAchievements = parsed.achievements || playerAchievements;
                        playerStats = parsed.stats || playerStats;
                        // inventory: try to map saved entries to characters (if saved as name/base)
                        if (Array.isArray(parsed.inventory) && parsed.inventory.length > 0) {
                            playerInventory = parsed.inventory.map(it => {
                                // If it's a whole object from previous save, keep it
                                if (it && it.name) return it;
                                // if it's an id/name, try to find character
                                const c = findCharacter(it) || window.characters.find(ch => ch.name === it || ch.baseName === it);
                                if (c) return { ...JSON.parse(JSON.stringify(c)), uid: 'card_' + Date.now() + '_' + Math.floor(Math.random()*10000) };
                                return null;
                            }).filter(Boolean);
                        }
                        // deck restore minimal
                        if (Array.isArray(parsed.deck)) {
                            playerDeck = parsed.deck.map(id => playerInventory.find(card => card.uid === id || card.id === id)).filter(Boolean);
                        }
                    } catch (e) {
                        logError(e);
                        initializeNewGameData();
                    }
                }

                function initializeNewGameData() {
                    try {
                        // ê¸°ë³¸ ì§€ê¸‰ ì¹´ë“œ (ì›ë³¸ê³¼ ë™ì¼í•œ ì´ë¦„ ì‚¬ìš©)
                        playerInventory = [];
                        addCardToInventory('[í¸ì§‘ì] ìœ¤í•„ê·œ');
                        addCardToInventory('[ì¡°ìˆ˜] í•œ í˜„');
                        playerBookmarks = MAX_BOOKMARKS;
                        lastBookmarkUpdateTime = Date.now();
                        saveGame();
                    } catch (e) {
                        logError(e);
                    }
                }

                function resetGame() {
                    try {
                        if (!isStorageAvailable()) return;
                        if (resetButton) {
                            if (resetButton.dataset.confirming === 'true') {
                                localStorage.removeItem(SAVE_DATA_KEY);
                                location.reload();
                            } else {
                                resetButton.textContent = 'í™•ì¸?';
                                resetButton.dataset.confirming = 'true';
                                resetButton.classList.remove('bg-red-600','hover:bg-red-700');
                                resetButton.classList.add('bg-yellow-500','hover:bg-yellow-600');
                                setTimeout(() => {
                                    resetButton.textContent = 'ì´ˆê¸°í™”';
                                    resetButton.dataset.confirming = 'false';
                                    resetButton.classList.remove('bg-yellow-500','hover:bg-yellow-600');
                                    resetButton.classList.add('bg-red-600','hover:bg-red-700');
                                }, 3000);
                            }
                        } else {
                            localStorage.removeItem(SAVE_DATA_KEY);
                            location.reload();
                        }
                    } catch (e) {
                        logError(e);
                    }
                }

                // --- UI ì—…ë°ì´íŠ¸ / íƒ­ ì œì–´ ---
                const tabButtons = Array.from(document.querySelectorAll('.tab-button'));
                // ì˜¬ë°”ë¥¸ allViews selector: interactive-story-modal ì¡´ì¬í•˜ë¯€ë¡œ ê·¸ê±¸ ì œì™¸
                const allViews = Array.from(document.querySelectorAll('main > div:not(#interactive-story-modal)'));

                function updateUI() {
                    try {
                        if (currencyDisplay) currencyDisplay.textContent = String(playerCurrency);
                        if (fountainPenDisplay) fountainPenDisplay.textContent = String(playerFountainPens);
                        if (bookmarkDisplay) bookmarkDisplay.textContent = String(playerBookmarks);
                        if (maxBookmarkDisplay) maxBookmarkDisplay.textContent = String(MAX_BOOKMARKS);
                        // inventory UI
                        if (inventoryContainer) {
                            inventoryContainer.innerHTML = '';
                            playerInventory.forEach(card => {
                                const el = document.createElement('div');
                                el.className = 'relative p-3 bg-black/10 rounded-lg text-white';
                                el.innerHTML = `
                                    <div class="font-bold">${card.name}</div>
                                    <div class="text-sm text-gray-300">Lv.${card.level || 1} â€¢ ${card.rarity || ''}</div>
                                `;
                                el.addEventListener('click', () => {
                                    showCardDetail(card);
                                });
                                inventoryContainer.appendChild(el);
                            });
                            if (inventoryStatus) inventoryStatus.textContent = `${playerInventory.length} / ${inventoryCapacity}`;
                        }
                        // results container: keep as is
                        // achievements
                        if (achievementsContainer) {
                            displayAchievements();
                        }
                    } catch (e) {
                        logError(e);
                    }
                }

                function switchTab(tabName) {
                    try {
                        // normalize: tabName could be 'home' (from id 'tab-home')
                        tabButtons.forEach(btn => {
                            btn.classList.remove('active','bg-yellow-400','text-indigo-900');
                            btn.classList.add('bg-gray-600');
                        });
                        allViews.forEach(v => v.classList.add('hidden'));
                        const tabButton = document.getElementById(`tab-${tabName}`);
                        const view = document.getElementById(`${tabName}-view`);
                        if (tabButton) {
                            tabButton.classList.add('active','bg-yellow-400','text-indigo-900');
                            tabButton.classList.remove('bg-gray-600');
                        }
                        if (view) view.classList.remove('hidden');
                    } catch (e) {
                        logError(e);
                    }
                }

                function checkEventStatus() {
                    // placeholder â€” ì´ë²¤íŠ¸ í™œì„±í™”/ë¹„í™œì„±í™” ì²´í¬
                    try {
                        if (!eventBanner) return;
                        // ì˜ˆì‹œ: no event => ìˆ¨ê¹€
                        eventBanner.classList.add('hidden');
                    } catch (e) { logError(e); }
                }

                // --- ì—…ì  ì²˜ë¦¬(ê°„ë‹¨) ---
                function displayAchievements() {
                    try {
                        if (!achievementsContainer) return;
                        achievementsContainer.innerHTML = '';
                        window.achievements.forEach(ach => {
                            const status = playerAchievements[ach.id] || null;
                            const achEl = document.createElement('div');
                            achEl.className = `p-4 rounded-lg flex justify-between items-center transition-all ${status ? 'bg-white/20' : 'bg-black/30 opacity-60'}`;
                            let rewardText = '';
                            if (ach.reward) {
                                if (ach.reward.currency) rewardText += `ğŸ’ ${ach.reward.currency} `;
                                if (ach.reward.bookmarks) rewardText += `ğŸ”– ${ach.reward.bookmarks}`;
                            }
                            let buttonHTML = '';
                            if (status === 'claimed') {
                                buttonHTML = `<button class="gacha-button bg-gray-600 text-white font-bold py-2 px-4 rounded-full text-sm" disabled>ë‹¬ì„± ì™„ë£Œ</button>`;
                            } else if (status === 'unlocked') {
                                buttonHTML = `<button data-ach-id="${ach.id}" class="claim-ach gacha-button bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full text-sm">ë³´ìƒ ë°›ê¸°</button>`;
                            } else {
                                buttonHTML = `<button class="gacha-button bg-gray-800 text-gray-400 font-bold py-2 px-4 rounded-full text-sm" disabled>ì§„í–‰ ì¤‘</button>`;
                            }
                            achEl.innerHTML = `
                                <div>
                                    <h3 class="text-lg font-bold ${status ? 'text-yellow-300' : 'text-gray-400'}">${ach.title}</h3>
                                    <p class="text-sm text-gray-300">${ach.description} (ë³´ìƒ: ${rewardText})</p>
                                </div>
                                ${buttonHTML}
                            `;
                            achievementsContainer.appendChild(achEl);
                        });
                        // attach claim handlers (delegation)
                        achievementsContainer.querySelectorAll('.claim-ach').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const id = btn.dataset['achId'];
                                claimAchievement(id);
                            });
                        });
                    } catch (e) { logError(e); }
                }

                function claimAchievement(id) {
                    try {
                        const ach = window.achievements.find(a => a.id === id);
                        if (!ach) return;
                        if (playerAchievements[id] !== 'unlocked') return;
                        if (ach.reward) {
                            if (ach.reward.currency) playerCurrency += ach.reward.currency;
                            if (ach.reward.bookmarks) playerBookmarks = Math.min(MAX_BOOKMARKS, playerBookmarks + ach.reward.bookmarks);
                        }
                        playerAchievements[id] = 'claimed';
                        saveGame();
                        updateUI();
                    } catch (e) { logError(e); }
                }

                // --- ì¹´ë“œ ìƒì„¸ ëª¨ë‹¬ ---
                function showCardDetail(card) {
                    try {
                        if (!cardDetailModal) return;
                        const nameEl = $id('detail-card-name');
                        if (nameEl) nameEl.textContent = card.name;
                        cardDetailModal.classList.remove('hidden');
                    } catch (e) { logError(e); }
                }

                function closeCardDetail() {
                    try {
                        if (!cardDetailModal) return;
                        cardDetailModal.classList.add('hidden');
                    } catch (e) { logError(e); }
                }

                // --- ë½‘ê¸° ê¸°ëŠ¥ (ê°„ë‹¨/ë™ì‘ ìš°ì„ ) ---
                function showResult(cards) {
                    try {
                        if (!resultsContainer) return;
                        resultsContainer.innerHTML = '';
                        cards.forEach(c => {
                            const el = document.createElement('div');
                            el.className = 'p-3 bg-black/20 rounded text-center';
                            el.textContent = c.name || 'Unknown';
                            resultsContainer.appendChild(el);
                        });
                    } catch (e) { logError(e); }
                }

                function pullOne() {
                    try {
                        if (playerCurrency < PULL_ONE_COST) {
                            if (messageArea) messageArea.textContent = 'ì¬í™”ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.';
                            return;
                        }
                        playerCurrency -= PULL_ONE_COST;
                        const pool = window.characters.length ? window.characters : [{name:'[ë¹ˆ ìŠ¬ë¡¯]'}];
                        const picked = pool[Math.floor(Math.random() * pool.length)];
                        const newCard = addCardToInventory(picked.name || picked.baseName || picked);
                        playerStats.totalPulls = (playerStats.totalPulls || 0) + 1;
                        saveGame();
                        updateUI();
                        showResult([picked]);
                    } catch (e) { logError(e); }
                }

                function pullTen() {
                    try {
                        if (playerCurrency < PULL_TEN_COST) {
                            if (messageArea) messageArea.textContent = 'ì¬í™”ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.';
                            return;
                        }
                        playerCurrency -= PULL_TEN_COST;
                        const pool = window.characters.length ? window.characters : [{name:'[ë¹ˆ ìŠ¬ë¡¯]'}];
                        const pulled = [];
                        for (let i=0;i<10;i++){
                            const p = pool[Math.floor(Math.random() * pool.length)];
                            addCardToInventory(p.name || p.baseName || p);
                            pulled.push(p);
                        }
                        playerStats.totalPulls = (playerStats.totalPulls || 0) + 10;
                        saveGame();
                        updateUI();
                        showResult(pulled);
                    } catch (e) { logError(e); }
                }

                // --- ì´ë²¤íŠ¸ ë°”ì¸ë”© (ì•ˆì „í•˜ê²Œ) ---
                if (pullOneButton) pullOneButton.addEventListener('click', pullOne);
                if (pullTenButton) pullTenButton.addEventListener('click', pullTen);
                if (resetButton) resetButton.addEventListener('click', resetGame);
                if (closeCardDetailButton) closeCardDetailButton.addEventListener('click', closeCardDetail);

                // íƒ­ ë°”ì¸ë”©
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        try {
                            const id = btn.id;
                            if (!id) return;
                            const key = id.replace(/^tab-/, '');
                            switchTab(key);
                        } catch (e) { logError(e); }
                    });
                });

                // ì¹´ë“œ ë”ë¸” í´ë¦­ í˜¹ì€ ê¸°íƒ€ ì•ˆì „ ì´ë²¤íŠ¸ëŠ” í•„ìš”ì‹œ ì¶”ê°€

                // --- ì´ˆê¸° ë¡œë“œ ---
                loadGame();
                updateUI();
                checkEventStatus();
                switchTab('home');

                // --- ì§„ë‹¨ ì¶œë ¥: ë§Œì•½ í´ë¦­ì´ ì•ˆë˜ë©´ ì½˜ì†” í™•ì¸í•˜ë¼ê³  ì•ˆë‚´ ---
                console.info('Game initialized. If UI not responding, check Console for errors.');
            } catch (e) {
                console.error('Fatal initialization error:', e);
                alert('ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™” ì¤‘ ì¹˜ëª…ì  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
            }
        });
    })();
    </script>
</body>
</html>
